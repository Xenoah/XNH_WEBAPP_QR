<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QuickQReader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { extend: { colors: { primary: '#3b82f6', secondary: '#64748b' } } }
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html { font-size: 16px; -webkit-text-size-adjust: 100%; }
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.55;
      letter-spacing: 0.01em;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .text-xs { font-size: 0.8125rem !important; line-height: 1.35rem !important; }
    .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-slide-up { animation: slideUp 0.25s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    canvas { max-width: 100%; height: auto; }
    .drop-active { outline: 3px dashed #3b82f6 !important; outline-offset: -3px; background-color: rgba(59,130,246,0.05) !important; }
    .complexity-bar { transition: width 0.5s cubic-bezier(.4,0,.2,1); }
    button svg,
    a svg {
      width: 0.55em !important;
      height: 0.55em !important;
    }
    @media (max-width: 640px) {
      body { line-height: 1.6; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const ReactDOM = window.ReactDOM;

    // ─── Icons ────────────────────────────────────────────────────────────────
    const I = (d, extra) => (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" dangerouslySetInnerHTML={{__html: d}} />;

    const Icons = {
      Camera:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
      Upload:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
      Copy:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
      Share2:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>,
      AlertCircle:   ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
      Settings:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
      Download:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
      SkipBack:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>,
      SkipForward:   ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>,
      RefreshCw:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
      CheckCircle2:  ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
      FileArchive:   ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M10 12v-1h4v1"/><path d="M10 18v-1h4v1"/><path d="M10 15v-1h4v1"/></svg>,
      Moon:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
      Sun:           ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>,
      Languages:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>,
      QrCode:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
      ScanLine:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>,
      RotateCcw:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
      FileCode:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 13 3 3-3 3"/><path d="m15 19-3-3 3-3"/></svg>,
      Clock:         ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
      X:             ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
      ExternalLink:  ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
      Mail:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
      Phone:         ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.99 9 19.79 19.79 0 0 1 1.93.37 2 2 0 0 1 3.91 0h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
      MapPin:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
      Wifi:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>,
      MessageSquare: ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
      UserPlus:      ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
      Link:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
      Type:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>,
      Eye:           ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
      EyeOff:        ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
      // New icons
      Star:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
      Printer:       ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
      Grid:          ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
      ImagePlus:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7"/><line x1="16" x2="22" y1="5" y2="5"/><line x1="19" x2="19" y1="2" y2="8"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
      Gauge:         ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
      SendHoriz:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>,
      Clipboard:     ({size=24,...p}) => <svg {...p} width={size} height={size} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>,
    };

    // ─── Constants ────────────────────────────────────────────────────────────
    const Language = { EN: 'en', JP: 'jp' };
    const Tab = { READ: 'read', GENERATE: 'generate' };
    const Theme = { LIGHT: 'light', DARK: 'dark' };
    const FAVORITES_KEY = 'qqr_favorites_v1';
    const QR_CAPACITY = { L: 2953, M: 2331, Q: 1663, H: 1273 };

    const DEFAULT_QR_SETTINGS = {
      text: 'https://example.com',
      fgColor: '#000000',
      bgColor: '#ffffff',
      level: 'M',
      includeMargin: true,
      shape: 'square',
      finderColor: '#000000',
      downloadSize: 512,
      transparentBg: false,
      logoSrc: null,
    };

    // ─── Translations ─────────────────────────────────────────────────────────
    const TRANSLATIONS = {
      en: {
        appTitle: 'QuickQReader', tabRead: 'Read QR', tabGen: 'Generate QR',
        scanCamera: 'Camera', uploadImage: 'Upload', urlImage: 'From URL',
        dragDrop: 'Drag & Drop or Click to Upload', dragDropActive: 'Drop image here',
        noQrFound: 'No QR code found in image.', scannedResult: 'Scanned Result',
        copy: 'Copy', share: 'Share', copied: 'Copied!', inputText: 'Enter URL or Text',
        paste: 'Paste', importCsv: 'Import CSV', preview: 'Preview', settings: 'Settings',
        color: 'Foreground Color', bgColor: 'Background Color',
        errCorrection: 'Error Correction', quietZone: 'Quiet Zone',
        finderColor: 'Finder Color', shape: 'Module Shape',
        generate: 'Generate', verify: 'Verify', download: 'Download PNG',
        downloadSvg: 'Download SVG', downloadZip: 'Download ZIP',
        generatingZip: 'Generating ZIP...', realtimePreview: 'Live Preview',
        csvNav: 'Record', startCamera: 'Start Camera', stopCamera: 'Stop Camera',
        cameraError: 'Camera access denied or unavailable.',
        verifying: 'Verifying...', verificationSuccess: 'Sent to Reader tab!',
        filePreview: 'Image Preview', reset: 'Reset',
        pasteError: 'Could not paste. Allow clipboard access or type manually.',
        libraryError: 'QR Library not loaded. Check internet connection.',
        trademark: 'QR Code is a registered trademark of DENSO WAVE INCORPORATED.',
        scanHistoryTitle: 'Recent Scans', clearHistory: 'Clear', noHistory: 'No recent scans.',
        templates: 'Quick Templates', charCount: 'chars',
        wifiSsid: 'Network Name (SSID)', wifiPassword: 'Password',
        wifiEncryption: 'Encryption', wifiHidden: 'Hidden Network',
        sendEmail: 'Send Email', callPhone: 'Call', sendSms: 'Send SMS',
        openMap: 'Open Map', saveContact: 'Save Contact',
        typeUrl: 'URL', typeEmail: 'Email', typePhone: 'Phone', typeSms: 'SMS',
        typeWifi: 'WiFi', typeVcard: 'Contact', typeGeo: 'Location', typeText: 'Text',
        cancelBtn: 'Cancel', confirmResetMsg: 'Reset all data? This cannot be undone.',
        confirmResetBtn: 'Reset', templateUrl: 'URL', templateWifi: 'WiFi',
        templateEmail: 'Email', templatePhone: 'Phone', templateText: 'Text', wifiEncNone: 'None',
        // New
        logoEmbed: 'Logo Overlay', uploadLogo: 'Upload Logo', removeLogo: 'Remove Logo',
        logoNote: 'Use Error Level H for logo readability',
        transparentBg: 'Transparent BG', downloadSize: 'Output Size',
        favorites: 'Favorites', saveFavorite: 'Save Favorite', loadFavorite: 'Load',
        noFavorites: 'No saved favorites.', printQR: 'Print', bulkPreview: 'Preview All',
        bulkPreviewTitle: 'Bulk QR Preview', complexity: 'Complexity',
        sendToGen: 'Generate', pasteToScan: 'Paste (Ctrl+V)',
        favName: 'Favorite name', save: 'Save', close: 'Close',
        downloadTransparent: 'Download (Transparent)',
        histExport: 'Export CSV',
      },
      jp: {
        appTitle: 'クイックQリーダー', tabRead: 'QRコード読み取り', tabGen: 'QRコード生成',
        scanCamera: 'カメラ', uploadImage: 'アップロード', urlImage: 'URLから',
        dragDrop: 'ドラッグ＆ドロップ または クリック', dragDropActive: 'ここにドロップ',
        noQrFound: 'QRコードが見つかりませんでした。', scannedResult: 'スキャン結果',
        copy: 'コピー', share: '共有', copied: 'コピー完了！', inputText: 'URLまたはテキストを入力',
        paste: '貼り付け', importCsv: 'CSV読み込み', preview: 'プレビュー', settings: '設定',
        color: '前景色', bgColor: '背景色',
        errCorrection: '誤り訂正レベル', quietZone: 'クワイエットゾーン',
        finderColor: 'ファインダ色', shape: '形状',
        generate: '生成', verify: '検証', download: 'ダウンロード (PNG)',
        downloadSvg: 'ダウンロード (SVG)', downloadZip: '一括ダウンロード (ZIP)',
        generatingZip: 'ZIP生成中...', realtimePreview: 'リアルタイム',
        csvNav: 'レコード', startCamera: 'カメラ起動', stopCamera: 'カメラ停止',
        cameraError: 'カメラへのアクセスが拒否されたか、利用できません。',
        verifying: '検証中...', verificationSuccess: '読み取りタブへ送信しました！',
        filePreview: '画像プレビュー', reset: 'リセット',
        pasteError: '貼り付けできませんでした。クリップボードのアクセスを許可してください。',
        libraryError: 'QRライブラリが読み込めません。インターネット接続を確認してください。',
        trademark: 'QRコードは株式会社デンソーウェーブの登録商標です。',
        scanHistoryTitle: '最近のスキャン', clearHistory: 'クリア', noHistory: 'スキャン履歴がありません。',
        templates: 'テンプレート', charCount: '文字',
        wifiSsid: 'ネットワーク名 (SSID)', wifiPassword: 'パスワード',
        wifiEncryption: '暗号化', wifiHidden: '非表示ネットワーク',
        sendEmail: 'メール送信', callPhone: '電話する', sendSms: 'SMS送信',
        openMap: 'マップを開く', saveContact: '連絡先に保存',
        typeUrl: 'URL', typeEmail: 'メール', typePhone: '電話', typeSms: 'SMS',
        typeWifi: 'WiFi', typeVcard: '連絡先', typeGeo: '位置情報', typeText: 'テキスト',
        cancelBtn: 'キャンセル', confirmResetMsg: 'すべてのデータをリセットしますか？この操作は元に戻せません。',
        confirmResetBtn: 'リセット', templateUrl: 'URL', templateWifi: 'WiFi',
        templateEmail: 'メール', templatePhone: '電話', templateText: 'テキスト', wifiEncNone: 'なし',
        // New
        logoEmbed: 'ロゴ埋め込み', uploadLogo: 'ロゴをアップロード', removeLogo: 'ロゴを削除',
        logoNote: 'ロゴ使用時は誤り訂正レベルHを推奨',
        transparentBg: '背景透過', downloadSize: '出力サイズ',
        favorites: 'お気に入り', saveFavorite: 'お気に入りに保存', loadFavorite: '読み込む',
        noFavorites: 'お気に入りがありません。', printQR: '印刷', bulkPreview: '一覧プレビュー',
        bulkPreviewTitle: '一括QRプレビュー', complexity: '複雑さ',
        sendToGen: '生成へ', pasteToScan: '貼り付け (Ctrl+V)',
        favName: 'お気に入り名', save: '保存', close: '閉じる',
        downloadTransparent: 'ダウンロード (透過)',
        histExport: 'CSV出力',
      }
    };

    // ─── QR Type Detection ────────────────────────────────────────────────────
    const detectQRType = (text) => {
      if (!text) return 'text';
      if (/^https?:\/\//i.test(text)) return 'url';
      if (/^mailto:/i.test(text)) return 'email';
      if (/^tel:/i.test(text)) return 'phone';
      if (/^sms:/i.test(text)) return 'sms';
      if (/^WIFI:/i.test(text)) return 'wifi';
      if (/^BEGIN:VCARD/i.test(text)) return 'vcard';
      if (/^geo:/i.test(text)) return 'geo';
      if (/^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/.test(text)) return 'email';
      return 'text';
    };
    const QR_TYPE_META = {
      url:   { color: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300',     key: 'typeUrl' },
      email: { color: 'bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300', key: 'typeEmail' },
      phone: { color: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300',  key: 'typePhone' },
      sms:   { color: 'bg-teal-100 dark:bg-teal-900/40 text-teal-700 dark:text-teal-300',     key: 'typeSms' },
      wifi:  { color: 'bg-cyan-100 dark:bg-cyan-900/40 text-cyan-700 dark:text-cyan-300',     key: 'typeWifi' },
      vcard: { color: 'bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300', key: 'typeVcard' },
      geo:   { color: 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300', key: 'typeGeo' },
      text:  { color: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300',        key: 'typeText' },
    };

    // ─── Helpers ──────────────────────────────────────────────────────────────
    const getComplexity = (text, level) => {
      if (!text) return 0;
      return Math.min(100, Math.round((text.length / (QR_CAPACITY[level] || 2331)) * 100));
    };
    const loadFavorites = () => {
      try { return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'); } catch { return []; }
    };
    const persistFavorites = (favs) => localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));

    const isFinderArea = (r, c, n) =>
      (r < 7 && c < 7) || (r < 7 && c >= n - 7) || (r >= n - 7 && c < 7);

    const hexToRgb = (hex) => {
      if (!hex || typeof hex !== 'string' || hex[0] !== '#' || hex.length !== 7) return { r: 0, g: 0, b: 0 };
      return {
        r: parseInt(hex.slice(1, 3), 16),
        g: parseInt(hex.slice(3, 5), 16),
        b: parseInt(hex.slice(5, 7), 16),
      };
    };

    const gcd = (a, b) => {
      let x = Math.abs(a), y = Math.abs(b);
      while (y) { const t = y; y = x % y; x = t; }
      return x || 1;
    };

    const renderDotsQR = (canvas, text, settings) => {
      if (!window.QRCode?.create) return false;
      const qr = window.QRCode.create(text, { errorCorrectionLevel: settings.level });
      const n = qr.modules.size;
      const marginModules = settings.includeMargin ? 4 : 1;
      const unit = settings.size / (n + marginModules * 2);
      const radius = Math.max(0.8, unit * 0.42);
      const offset = unit * marginModules;
      const ctx = canvas.getContext('2d');
      if (!ctx) return false;

      ctx.clearRect(0, 0, settings.size, settings.size);
      ctx.fillStyle = settings.bgColor;
      ctx.fillRect(0, 0, settings.size, settings.size);

      for (let r = 0; r < n; r++) {
        for (let c = 0; c < n; c++) {
          if (!qr.modules.get(r, c)) continue;
          const x = offset + c * unit + unit / 2;
          const y = offset + r * unit + unit / 2;
          ctx.fillStyle = isFinderArea(r, c, n) ? (settings.finderColor || settings.fgColor) : settings.fgColor;
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      return true;
    };

    const renderDotsFromCanvas = (canvas, opts) => {
      const ctx = canvas.getContext('2d');
      if (!ctx) return false;
      const w = canvas.width, h = canvas.height;
      const id = ctx.getImageData(0, 0, w, h);
      const d = id.data;
      const fg = hexToRgb(opts.fgColor);
      const bg = hexToRgb(opts.bgColor);
      const isDark = (x, y) => {
        const i = (y * w + x) * 4;
        const dFg = Math.abs(d[i] - fg.r) + Math.abs(d[i + 1] - fg.g) + Math.abs(d[i + 2] - fg.b);
        const dBg = Math.abs(d[i] - bg.r) + Math.abs(d[i + 1] - bg.g) + Math.abs(d[i + 2] - bg.b);
        return dFg <= dBg;
      };

      let minX = w, minY = h, maxX = -1, maxY = -1;
      for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {
          if (!isDark(x, y)) continue;
          if (x < minX) minX = x;
          if (y < minY) minY = y;
          if (x > maxX) maxX = x;
          if (y > maxY) maxY = y;
        }
      }
      if (maxX < minX || maxY < minY) return false;

      const probeY = Math.floor((minY + maxY) / 2);
      const runs = [];
      let prev = isDark(minX, probeY), len = 1;
      for (let x = minX + 1; x <= maxX; x++) {
        const cur = isDark(x, probeY);
        if (cur === prev) len++;
        else { runs.push(len); len = 1; prev = cur; }
      }
      runs.push(len);
      const validRuns = runs.filter(v => v > 0);
      if (!validRuns.length) return false;
      const moduleSize = Math.max(1, validRuns.reduce((acc, v) => gcd(acc, v), validRuns[0]));
      const n = Math.round((maxX - minX + 1) / moduleSize);
      if (n < 21) return false;

      ctx.clearRect(0, 0, w, h);
      ctx.fillStyle = opts.bgColor;
      ctx.fillRect(0, 0, w, h);
      const radius = Math.max(0.8, moduleSize * 0.42);
      for (let r = 0; r < n; r++) {
        for (let c = 0; c < n; c++) {
          const sx = Math.min(w - 1, Math.round(minX + c * moduleSize + moduleSize / 2));
          const sy = Math.min(h - 1, Math.round(minY + r * moduleSize + moduleSize / 2));
          if (!isDark(sx, sy)) continue;
          const cx = minX + c * moduleSize + moduleSize / 2;
          const cy = minY + r * moduleSize + moduleSize / 2;
          ctx.fillStyle = isFinderArea(r, c, n) ? (opts.finderColor || opts.fgColor) : opts.fgColor;
          ctx.beginPath();
          ctx.arc(cx, cy, radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      return true;
    };

    const drawQRBase = (canvas, text, size, settings) => new Promise((resolve, reject) => {
      if (!window.QRCode) { reject(new Error('QRCode lib not loaded')); return; }
      const opts = {
        size,
        level: settings.level,
        includeMargin: settings.includeMargin,
        bgColor: settings.bgColor,
        fgColor: settings.fgColor,
        finderColor: settings.finderColor,
      };
      if (settings.shape === 'dots' && renderDotsQR(canvas, text, opts)) {
        resolve();
        return;
      }
      window.QRCode.toCanvas(canvas, text, {
        width: size,
        margin: settings.includeMargin ? 4 : 1,
        color: { dark: settings.fgColor, light: settings.bgColor },
        errorCorrectionLevel: settings.level
      }, (err) => {
        if (err) { reject(err); return; }
        if (settings.shape === 'dots') {
          const ok = renderDotsFromCanvas(canvas, opts);
          if (!ok) { reject(new Error('Dots render failed')); return; }
        }
        resolve();
      });
    });

    // Build QR on offscreen canvas (returns Promise<HTMLCanvasElement>)
    const buildQRCanvas = (text, size, settings) => new Promise((resolve, reject) => {
      const c = document.createElement('canvas');
      c.width = size; c.height = size;
      drawQRBase(c, text, size, settings).then(() => {
        if (settings.logoSrc) {
          const img = new Image();
          img.onload = () => {
            const ctx = c.getContext('2d');
            const ls = size * 0.22;
            const x = (size - ls) / 2, y = (size - ls) / 2;
            ctx.fillStyle = settings.bgColor || '#ffffff';
            ctx.beginPath();
            ctx.arc(size / 2, size / 2, ls / 2 + 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.drawImage(img, x, y, ls, ls);
            resolve(c);
          };
          img.onerror = () => resolve(c);
          img.src = settings.logoSrc;
        } else {
          resolve(c);
        }
      }).catch(reject);
    });

    // Apply transparency by replacing bg-colored pixels with alpha=0
    const applyTransparency = (canvas, bgColor) => {
      const ctx = canvas.getContext('2d');
      const id = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const d = id.data;
      const r = parseInt(bgColor.slice(1, 3), 16);
      const g = parseInt(bgColor.slice(3, 5), 16);
      const b = parseInt(bgColor.slice(5, 7), 16);
      for (let i = 0; i < d.length; i += 4) {
        if (Math.abs(d[i]-r)<20 && Math.abs(d[i+1]-g)<20 && Math.abs(d[i+2]-b)<20) d[i+3] = 0;
      }
      ctx.putImageData(id, 0, 0);
      return canvas;
    };

    // ─── Toast ────────────────────────────────────────────────────────────────
    const ToastContainer = ({ toasts }) => (
      <div className="fixed bottom-5 right-5 flex flex-col gap-2 z-[100] pointer-events-none">
        {toasts.map(t => (
          <div key={t.id} className={`flex items-center gap-2 px-4 py-3 rounded-xl shadow-2xl text-sm font-medium animate-slide-up max-w-xs ${
            t.type==='success'?'bg-green-600 text-white':t.type==='error'?'bg-red-600 text-white':t.type==='info'?'bg-blue-600 text-white':'bg-gray-900 text-white'
          }`}>
            {t.type==='success'&&<Icons.CheckCircle2 size={16} className="shrink-0"/>}
            {t.type==='error'&&<Icons.AlertCircle size={16} className="shrink-0"/>}
            {t.type==='info'&&<Icons.ScanLine size={16} className="shrink-0"/>}
            <span>{t.message}</span>
          </div>
        ))}
      </div>
    );

    // ─── Confirm Dialog ───────────────────────────────────────────────────────
    const ConfirmDialog = ({ message, confirmLabel, cancelLabel, onConfirm, onCancel }) => (
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[200] animate-fade-in">
        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 animate-slide-up">
          <p className="text-gray-700 dark:text-gray-200 mb-6 leading-relaxed">{message}</p>
          <div className="flex gap-3 justify-end">
            <button onClick={onCancel} className="px-5 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium">{cancelLabel}</button>
            <button onClick={onConfirm} className="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors font-medium">{confirmLabel}</button>
          </div>
        </div>
      </div>
    );

    // ─── Favorites Modal ──────────────────────────────────────────────────────
    const FavoritesModal = ({ settings, onLoad, onClose, t, showToast }) => {
      const [favs, setFavs] = useState(loadFavorites);
      const [newName, setNewName] = useState('');
      const handleSave = () => {
        if (!newName.trim()) return;
        const fav = { id: Date.now(), name: newName.trim(), settings: { ...settings, logoSrc: null } };
        const updated = [fav, ...favs];
        setFavs(updated); persistFavorites(updated); setNewName('');
        showToast(t('saveFavorite'), 'success');
      };
      const handleDelete = (id) => {
        const updated = favs.filter(f => f.id !== id);
        setFavs(updated); persistFavorites(updated);
      };
      return (
        <div className="fixed inset-0 bg-black/60 z-[200] flex items-center justify-center animate-fade-in p-4">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-sm w-full max-h-[70vh] flex flex-col animate-slide-up">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold text-lg flex items-center gap-2"><Icons.Star size={18}/> {t('favorites')}</h3>
              <button onClick={onClose} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"><Icons.X size={18}/></button>
            </div>
            <div className="flex gap-2 mb-4">
              <input value={newName} onChange={e=>setNewName(e.target.value)}
                placeholder={t('favName')} onKeyDown={e=>e.key==='Enter'&&handleSave()}
                className="flex-1 px-3 py-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none"/>
              <button onClick={handleSave} disabled={!newName.trim()}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors disabled:opacity-40">{t('save')}</button>
            </div>
            <div className="overflow-y-auto flex-1 space-y-2">
              {favs.length===0 ? (
                <p className="text-gray-400 text-sm text-center py-6">{t('noFavorites')}</p>
              ) : favs.map(fav => (
                <div key={fav.id} className="flex items-center gap-2 p-3 rounded-xl bg-gray-50 dark:bg-gray-700/60">
                  <Icons.Star size={14} className="text-yellow-500 shrink-0"/>
                  <span className="flex-1 text-sm font-medium truncate">{fav.name}</span>
                  <button onClick={()=>{onLoad(fav.settings);onClose();}}
                    className="px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-md text-xs font-semibold hover:bg-blue-200 transition-colors">{t('loadFavorite')}</button>
                  <button onClick={()=>handleDelete(fav.id)} className="p-1 text-gray-400 hover:text-red-500 transition-colors"><Icons.X size={13}/></button>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    };

    // ─── Bulk Preview Modal ───────────────────────────────────────────────────
    const BulkPreviewModal = ({ records, settings, onClose, t }) => {
      const [previews, setPreviews] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => {
        let cancelled = false;
        const generate = async () => {
          const results = [];
          const limit = Math.min(records.length, 60);
          for (let i = 0; i < limit; i++) {
            try {
              const canvas = await buildQRCanvas(records[i].data, 128, settings);
              const url = canvas.toDataURL('image/png');
              results.push({ id: records[i].id, data: records[i].data, src: url });
            } catch {}
          }
          if (!cancelled) { setPreviews(results); setLoading(false); }
        };
        generate();
        return () => { cancelled = true; };
      }, []);
      return (
        <div className="fixed inset-0 bg-black/70 z-[300] flex items-center justify-center animate-fade-in p-4">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full max-h-[85vh] flex flex-col animate-slide-up">
            <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
              <h2 className="font-bold text-lg flex items-center gap-2"><Icons.Grid size={18}/> {t('bulkPreviewTitle')} ({records.length})</h2>
              <button onClick={onClose} className="p-1.5 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"><Icons.X size={20}/></button>
            </div>
            <div className="overflow-y-auto flex-1 p-4">
              {loading ? (
                <div className="flex items-center justify-center h-40 gap-3 text-gray-400">
                  <Icons.RefreshCw size={24} className="animate-spin"/> Generating...
                </div>
              ) : (
                <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                  {previews.map(p => (
                    <div key={p.id} className="flex flex-col items-center gap-1.5">
                      <img src={p.src} alt={p.data} className="rounded-lg border border-gray-200 dark:border-gray-600 w-full"/>
                      <span className="text-[10px] text-gray-500 dark:text-gray-400 truncate w-full text-center">{p.data}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ─── QRCodeCanvas (with logo overlay) ────────────────────────────────────
    const QRCodeCanvas = ({ value, size, bgColor, fgColor, level, includeMargin, shape, finderColor, logoSrc, onError }) => {
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!value) return;
        const generate = () => {
          if (!window.QRCode || typeof window.QRCode.toCanvas !== 'function') {
            setTimeout(generate, 1000); return;
          }
          if (!canvasRef.current) return;
          drawQRBase(canvasRef.current, value, size, {
            bgColor,
            fgColor,
            finderColor,
            level,
            includeMargin,
            shape,
          }).then(() => {
            if (logoSrc && canvasRef.current) {
              const ctx = canvasRef.current.getContext('2d');
              const img = new Image();
              img.onload = () => {
                const ls = size * 0.22;
                const x = (size - ls) / 2, y = (size - ls) / 2;
                ctx.fillStyle = bgColor || '#ffffff';
                ctx.beginPath(); ctx.arc(size/2, size/2, ls/2+8, 0, Math.PI*2); ctx.fill();
                ctx.drawImage(img, x, y, ls, ls);
              };
              img.src = logoSrc;
            }
          }).catch(() => {
            if (onError) onError();
          });
        };
        generate();
      }, [value, size, bgColor, fgColor, level, includeMargin, shape, finderColor, logoSrc]);
      return <canvas ref={canvasRef}/>;
    };

    // ─── QRReader ─────────────────────────────────────────────────────────────
    const QRReader = ({ lang, initialImage, showToast, onSendToGenerator }) => {
      const t = (key) => TRANSLATIONS[lang][key];
      const [activeMode, setActiveMode] = useState('camera');
      const [scanResult, setScanResult] = useState(null);
      const [error, setError] = useState(null);
      const [isCopied, setIsCopied] = useState(false);
      const [previewImage, setPreviewImage] = useState(null);
      const [scanHistory, setScanHistory] = useState([]);
      const [isDragging, setIsDragging] = useState(false);
      const videoRef = useRef(null);
      const canvasRef = useRef(null);
      const [isCameraActive, setIsCameraActive] = useState(false);
      const requestRef = useRef(0);

      const addToHistory = useCallback((text) => {
        setScanHistory(prev => {
          const entry = { text, time: Date.now() };
          const filtered = prev.filter(h => h.text !== text);
          return [entry, ...filtered].slice(0, 10);
        });
      }, []);

      const scanImage = useCallback((src) => {
        const img = new Image();
        img.onload = () => {
          const c = document.createElement('canvas');
          c.width = img.width; c.height = img.height;
          const ctx = c.getContext('2d');
          if (ctx) {
            ctx.drawImage(img, 0, 0);
            const id = ctx.getImageData(0, 0, c.width, c.height);
            if (window.jsQR) {
              const code = window.jsQR(id.data, id.width, id.height, { inversionAttempts: 'dontInvert' });
              if (code) { setScanResult(code.data); setError(null); addToHistory(code.data); }
              else { setError(t('noQrFound')); setScanResult(null); }
            }
          }
        };
        img.onerror = () => setError(t('noQrFound'));
        img.src = src;
      }, [t, addToHistory]);

      useEffect(() => {
        if (initialImage) { setActiveMode('file'); setPreviewImage(initialImage); scanImage(initialImage); }
      }, [initialImage, scanImage]);

      const stopCamera = useCallback(() => {
        if (videoRef.current?.srcObject) {
          videoRef.current.srcObject.getTracks().forEach(t => t.stop());
          videoRef.current.srcObject = null;
        }
        if (requestRef.current) cancelAnimationFrame(requestRef.current);
        setIsCameraActive(false);
      }, []);

      const tick = useCallback(() => {
        if (videoRef.current?.readyState === videoRef.current?.HAVE_ENOUGH_DATA) {
          const c = canvasRef.current, v = videoRef.current;
          if (c && window.jsQR) {
            c.height = v.videoHeight; c.width = v.videoWidth;
            const ctx = c.getContext('2d');
            if (ctx) {
              ctx.drawImage(v, 0, 0, c.width, c.height);
              const id = ctx.getImageData(0, 0, c.width, c.height);
              const code = window.jsQR(id.data, id.width, id.height, { inversionAttempts: 'dontInvert' });
              if (code) { setScanResult(code.data); setError(null); addToHistory(code.data); }
            }
          }
        }
        requestRef.current = requestAnimationFrame(tick);
      }, [addToHistory]);

      const startCamera = async () => {
        setError(null); setPreviewImage(null); setScanResult(null);
        if (window.location.protocol === 'file:') {
          setError(lang==='jp'
            ? 'セキュリティ上の制限により、ローカルファイル(file://)からカメラを起動できません。'
            : 'Camera access is restricted on local files. Use GitHub Pages or localhost.');
          return;
        }
        if (!navigator.mediaDevices?.getUserMedia) { setError(t('cameraError')); return; }
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            videoRef.current.setAttribute('playsinline', 'true');
            videoRef.current.play();
            setIsCameraActive(true);
            requestRef.current = requestAnimationFrame(tick);
          }
        } catch { setError(t('cameraError')); setIsCameraActive(false); }
      };

      useEffect(() => () => stopCamera(), [stopCamera, activeMode]);

      // Ctrl+V paste to scan
      useEffect(() => {
        const handlePaste = async (e) => {
          const items = e.clipboardData?.items;
          if (!items) return;
          for (const item of items) {
            if (item.type.startsWith('image/')) {
              const file = item.getAsFile();
              if (file) {
                setActiveMode('file'); setError(null); setScanResult(null);
                const reader = new FileReader();
                reader.onload = (ev) => { setPreviewImage(ev.target.result); scanImage(ev.target.result); };
                reader.readAsDataURL(file);
              }
              break;
            }
          }
        };
        window.addEventListener('paste', handlePaste);
        return () => window.removeEventListener('paste', handlePaste);
      }, [scanImage]);

      const loadImageFile = (file) => {
        if (!file || !file.type.startsWith('image/')) return;
        setError(null); setScanResult(null); setPreviewImage(null);
        const reader = new FileReader();
        reader.onload = (ev) => { setPreviewImage(ev.target.result); scanImage(ev.target.result); };
        reader.readAsDataURL(file);
      };

      const handleDragOver = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(true); };
      const handleDragLeave = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); };
      const handleDrop = (e) => {
        e.preventDefault(); e.stopPropagation(); setIsDragging(false);
        const file = e.dataTransfer.files?.[0];
        if (file) { setActiveMode('file'); loadImageFile(file); }
      };

      const copyToClipboard = () => {
        if (scanResult) {
          navigator.clipboard.writeText(scanResult);
          setIsCopied(true); setTimeout(() => setIsCopied(false), 2000);
          if (showToast) showToast(t('copied'), 'success');
        }
      };
      const shareResult = async () => {
        if (scanResult && navigator.share) {
          try { await navigator.share({ title: 'Scanned QR Code', text: scanResult }); } catch {}
        }
      };
      const exportHistoryCsv = () => {
        if (!scanHistory.length) return;
        const csv = scanHistory.map(h => `"${h.text.replace(/"/g,'""')}"`).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'scan_history.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      };

      const qrType = scanResult ? detectQRType(scanResult) : 'text';
      const typeMeta = QR_TYPE_META[qrType] || QR_TYPE_META.text;

      const getActionButton = () => {
        if (!scanResult) return null;
        switch (qrType) {
          case 'url': return <a href={scanResult} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1.5 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.ExternalLink size={15}/> Open Link</a>;
          case 'email': { const href=/^mailto:/i.test(scanResult)?scanResult:`mailto:${scanResult}`; return <a href={href} className="flex items-center gap-1.5 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.Mail size={15}/> {t('sendEmail')}</a>; }
          case 'phone': { const href=/^tel:/i.test(scanResult)?scanResult:`tel:${scanResult}`; return <a href={href} className="flex items-center gap-1.5 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.Phone size={15}/> {t('callPhone')}</a>; }
          case 'sms': return <a href={scanResult} className="flex items-center gap-1.5 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.MessageSquare size={15}/> {t('sendSms')}</a>;
          case 'geo': { const coords=scanResult.replace(/^geo:/i,'').split(',').slice(0,2).join(','); return <a href={`https://maps.google.com/?q=${coords}`} target="_blank" rel="noopener noreferrer" className="flex items-center gap-1.5 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.MapPin size={15}/> {t('openMap')}</a>; }
          case 'vcard': return <button onClick={()=>{const blob=new Blob([scanResult],{type:'text/vcard'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='contact.vcf';a.click();URL.revokeObjectURL(url);}} className="flex items-center gap-1.5 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors"><Icons.UserPlus size={15}/> {t('saveContact')}</button>;
          case 'wifi': { const m=scanResult.match(/S:([^;]*)/); return <span className="flex items-center gap-1.5 px-3 py-2 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 rounded-lg text-sm font-medium"><Icons.Wifi size={15}/> {m?m[1]:'WiFi'}</span>; }
          default: return null;
        }
      };

      return (
        <div className={`flex flex-col gap-5 max-w-3xl mx-auto ${isDragging?'drop-active':''}`}
          onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
          {isDragging && (
            <div className="fixed inset-0 z-50 pointer-events-none flex items-center justify-center">
              <div className="bg-blue-600/90 text-white px-8 py-6 rounded-2xl shadow-2xl text-xl font-bold flex flex-col items-center gap-3">
                <Icons.Upload size={40}/>{t('dragDropActive')}
              </div>
            </div>
          )}

          {/* Mode Switcher + Paste hint */}
          <div className="flex flex-col sm:flex-row sm:items-center gap-3">
            <div className="flex gap-1 bg-gray-200 dark:bg-gray-800 p-1 rounded-xl flex-1 sm:flex-none">
              {[['camera',Icons.Camera,t('scanCamera')],['file',Icons.Upload,t('uploadImage')]].map(([mode,Icon,label])=>(
                <button key={mode} onClick={()=>setActiveMode(mode)}
                  className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-all text-sm font-medium flex-1 justify-center ${activeMode===mode?'bg-white dark:bg-gray-700 shadow-sm text-blue-600 dark:text-blue-400':'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}>
                  <Icon size={16}/>{label}
                </button>
              ))}
            </div>
            <span className="text-xs text-gray-400 dark:text-gray-500 sm:ml-auto">{t('pasteToScan')}</span>
          </div>

          {/* Input Area */}
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 min-h-[280px] flex flex-col items-center justify-center border border-gray-100 dark:border-gray-700">
            {activeMode==='camera' && (
              <div className="w-full flex flex-col items-center gap-4">
                <div className="relative w-full max-w-md aspect-square bg-gray-900 rounded-xl overflow-hidden">
                  <video ref={videoRef} className="w-full h-full object-cover"/>
                  <canvas ref={canvasRef} className="hidden"/>
                  {!isCameraActive && <div className="absolute inset-0 flex items-center justify-center text-white/20"><Icons.Camera size={64}/></div>}
                  {isCameraActive && (
                    <div className="absolute inset-0 pointer-events-none">
                      <div className="absolute inset-[18%] border-2 border-white/50 rounded-xl"></div>
                      <div className="absolute top-[18%] left-[18%] w-6 h-6 border-t-2 border-l-2 border-blue-400 rounded-tl-lg"></div>
                      <div className="absolute top-[18%] right-[18%] w-6 h-6 border-t-2 border-r-2 border-blue-400 rounded-tr-lg"></div>
                      <div className="absolute bottom-[18%] left-[18%] w-6 h-6 border-b-2 border-l-2 border-blue-400 rounded-bl-lg"></div>
                      <div className="absolute bottom-[18%] right-[18%] w-6 h-6 border-b-2 border-r-2 border-blue-400 rounded-br-lg"></div>
                    </div>
                  )}
                </div>
                <button onClick={isCameraActive?stopCamera:startCamera}
                  className={`px-8 py-2.5 rounded-full font-semibold text-white transition-all shadow-md active:scale-95 ${isCameraActive?'bg-red-500 hover:bg-red-600':'bg-blue-600 hover:bg-blue-700'}`}>
                  {isCameraActive?t('stopCamera'):t('startCamera')}
                </button>
              </div>
            )}
            {activeMode==='file' && (
              <div className="w-full max-w-md flex flex-col items-center gap-4">
                <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl cursor-pointer bg-gray-50 dark:bg-gray-700/50 hover:bg-blue-50 dark:hover:bg-blue-900/10 hover:border-blue-400 transition-all">
                  <Icons.Upload className="w-8 h-8 text-gray-400 mb-2"/>
                  <p className="text-sm text-gray-500 dark:text-gray-400 font-medium">{t('dragDrop')}</p>
                  <input type="file" className="hidden" accept="image/*" onChange={e=>loadImageFile(e.target.files?.[0])}/>
                </label>
                {previewImage && (
                  <div className="w-full border border-gray-200 dark:border-gray-700 rounded-xl p-3 bg-gray-50 dark:bg-gray-900">
                    <div className="text-xs text-gray-400 mb-2 font-medium">{t('filePreview')}</div>
                    <img src={previewImage} alt="Preview" className="max-h-64 mx-auto rounded-lg shadow-sm"/>
                  </div>
                )}
              </div>
            )}
            {error && (
              <div className="mt-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-xl flex items-center gap-2 animate-fade-in w-full max-w-md border border-red-100 dark:border-red-800">
                <Icons.AlertCircle size={18} className="shrink-0"/><span className="text-sm">{error}</span>
              </div>
            )}
          </div>

          {/* Scan Result */}
          {scanResult && (
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-green-100 dark:border-green-900/40 animate-slide-up">
              <div className="flex items-center gap-2 mb-3 flex-wrap">
                <Icons.CheckCircle2 size={20} className="text-green-500"/>
                <h3 className="text-lg font-bold text-gray-800 dark:text-gray-100">{t('scannedResult')}</h3>
                <span className={`text-xs px-2.5 py-0.5 rounded-full font-semibold ${typeMeta.color}`}>{t(typeMeta.key)}</span>
              </div>
              <div className="bg-gray-50 dark:bg-gray-900 p-4 rounded-xl font-mono break-all text-sm mb-4 border border-gray-200 dark:border-gray-700">{scanResult}</div>
              <div className="flex gap-2 flex-wrap items-center">
                <button onClick={copyToClipboard} className="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors">
                  <Icons.Copy size={15}/>{isCopied?t('copied'):t('copy')}
                </button>
                {navigator.share && (
                  <button onClick={shareResult} className="flex items-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors">
                    <Icons.Share2 size={15}/>{t('share')}
                  </button>
                )}
                {onSendToGenerator && (
                  <button onClick={()=>onSendToGenerator(scanResult)}
                    className="flex items-center gap-2 px-4 py-2 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 hover:bg-indigo-200 dark:hover:bg-indigo-900/50 rounded-lg text-sm font-medium transition-colors">
                    <Icons.QrCode size={15}/>{t('sendToGen')}
                  </button>
                )}
                <div className="ml-auto">{getActionButton()}</div>
              </div>
            </div>
          )}

          {/* Scan History */}
          {scanHistory.length>0 && (
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-4 border border-gray-100 dark:border-gray-700 animate-fade-in">
              <div className="flex justify-between items-center mb-3">
                <h3 className="font-semibold text-sm text-gray-600 dark:text-gray-300 flex items-center gap-1.5"><Icons.Clock size={15}/>{t('scanHistoryTitle')}</h3>
                <div className="flex gap-2">
                  <button onClick={exportHistoryCsv} className="text-xs text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition-colors flex items-center gap-1">
                    <Icons.Download size={12}/>{t('histExport')}
                  </button>
                  <button onClick={()=>setScanHistory([])} className="text-xs text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors flex items-center gap-1">
                    <Icons.X size={12}/>{t('clearHistory')}
                  </button>
                </div>
              </div>
              <div className="space-y-1.5">
                {scanHistory.map(entry => {
                  const etype = detectQRType(entry.text);
                  const emeta = QR_TYPE_META[etype] || QR_TYPE_META.text;
                  return (
                    <div key={entry.time} className="flex items-center gap-2 p-2.5 rounded-xl bg-gray-50 dark:bg-gray-700/60 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                      <button onClick={()=>setScanResult(entry.text)} className="flex-1 text-left flex items-center gap-2 min-w-0">
                        <Icons.Clock size={12} className="text-gray-400 shrink-0"/>
                        <span className="flex-1 font-mono truncate text-gray-600 dark:text-gray-300 text-xs">{entry.text}</span>
                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-semibold shrink-0 ${emeta.color}`}>{TRANSLATIONS[lang][emeta.key]}</span>
                      </button>
                      {onSendToGenerator && (
                        <button onClick={()=>onSendToGenerator(entry.text)}
                          className="shrink-0 p-1.5 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors" title={t('sendToGen')}>
                          <Icons.SendHoriz size={13}/>
                        </button>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}
        </div>
      );
    };

    // ─── QRGenerator ──────────────────────────────────────────────────────────
    const QRGenerator = ({ lang, onVerify, showToast, initialText }) => {
      const t = (key) => TRANSLATIONS[lang][key];
      const [settings, setSettings] = useState(DEFAULT_QR_SETTINGS);
      const [inputText, setInputText] = useState('');
      const [csvRecords, setCsvRecords] = useState([]);
      const [currentCsvIndex, setCurrentCsvIndex] = useState(0);
      const [realtimePreview, setRealtimePreview] = useState(true);
      const [showSettings, setShowSettings] = useState(false);
      const [previewKey, setPreviewKey] = useState(0);
      const [isZipping, setIsZipping] = useState(false);
      const [libError, setLibError] = useState(false);
      const [activeTemplate, setActiveTemplate] = useState('url');
      const [wifiForm, setWifiForm] = useState({ ssid: '', password: '', encryption: 'WPA', hidden: false });
      const [showWifiPw, setShowWifiPw] = useState(false);
      const [showFavorites, setShowFavorites] = useState(false);
      const [showBulkPreview, setShowBulkPreview] = useState(false);
      const [displayParams, setDisplayParams] = useState(DEFAULT_QR_SETTINGS);
      const qrCanvasRef = useRef(null);

      // Accept text from reader history
      useEffect(() => {
        if (initialText) { setInputText(initialText); setCsvRecords([]); setActiveTemplate(''); }
      }, [initialText]);

      // WiFi form sync
      useEffect(() => {
        if (activeTemplate==='wifi' && wifiForm.ssid) {
          setInputText(`WIFI:T:${wifiForm.encryption};S:${wifiForm.ssid};P:${wifiForm.password};H:${wifiForm.hidden?'true':'false'};;`);
          setCsvRecords([]);
        }
      }, [wifiForm, activeTemplate]);

      // Sync text → settings
      useEffect(() => {
        if (csvRecords.length>0) setSettings(p=>({...p,text:csvRecords[currentCsvIndex].data}));
        else if (inputText) setSettings(p=>({...p,text:inputText}));
      }, [csvRecords, currentCsvIndex, inputText]);

      useEffect(() => { if (realtimePreview) setDisplayParams(settings); }, [settings, realtimePreview]);

      const handleTemplateChange = (tpl) => {
        setActiveTemplate(tpl); setCsvRecords([]);
        if (tpl==='url') setInputText('https://');
        else if (tpl==='email') setInputText('mailto:');
        else if (tpl==='phone') setInputText('tel:+');
        else if (tpl==='sms') setInputText('sms:+');
        else if (tpl==='text') setInputText('');
        else if (tpl==='wifi') { setWifiForm({ssid:'',password:'',encryption:'WPA',hidden:false}); setInputText(''); }
      };

      const handleCsvUpload = (e) => {
        const file = e.target.files?.[0];
        if (file && window.Papa) {
          window.Papa.parse(file, { complete: (results) => {
            const records = results.data.flat().filter(c=>typeof c==='string'&&c.trim()!=='').map((text,i)=>({id:i,data:text}));
            if (records.length>0) { setCsvRecords(records); setCurrentCsvIndex(0); setActiveTemplate(''); }
          }});
        }
      };

      const handlePaste = async () => {
        try { const text=await navigator.clipboard.readText(); setInputText(text); setCsvRecords([]); setActiveTemplate(''); }
        catch { if (showToast) showToast(t('pasteError'),'error'); }
      };

      const handleLogoUpload = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => { updateSetting('logoSrc', ev.target.result); if (settings.level!=='H') updateSetting('level','H'); };
        reader.readAsDataURL(file);
      };

      const updateSetting = (key, value) => setSettings(p=>({...p,[key]:value}));
      const triggerManualGenerate = () => { setDisplayParams(settings); setPreviewKey(p=>p+1); };

      // Download PNG (with size, logo, transparent)
      const downloadQR = async () => {
        if (!settings.text) return;
        const size = settings.downloadSize || 512;
        try {
          let canvas = await buildQRCanvas(settings.text, size, settings);
          if (settings.transparentBg) canvas = applyTransparency(canvas, settings.bgColor);
          const url = canvas.toDataURL('image/png');
          const a = document.createElement('a'); a.href=url; a.download=`qrcode-${Date.now()}.png`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          if (showToast) showToast(t('download'),'success');
        } catch { if (showToast) showToast('Download failed.','error'); }
      };

      const downloadSVG = () => {
        if (!settings.text || !window.QRCode?.toString) { if (showToast) showToast(t('libraryError'),'error'); return; }
        window.QRCode.toString(settings.text, {
          errorCorrectionLevel: settings.level, margin: settings.includeMargin?4:1,
          color: { dark: settings.fgColor, light: settings.bgColor }, width: 512, type: 'svg'
        }, (err, svg) => {
          if (err) { if (showToast) showToast('SVG error','error'); return; }
          const blob = new Blob([svg],{type:'image/svg+xml'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download=`qrcode-${Date.now()}.svg`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
          if (showToast) showToast(t('downloadSvg'),'success');
        });
      };

      const handleZipDownload = async () => {
        if (!csvRecords.length || !window.JSZip || !window.QRCode) return;
        setIsZipping(true);
        try {
          const zip = new window.JSZip();
          const folder = zip.folder('qrcodes');
          for (const rec of csvRecords) {
            const canvas = await buildQRCanvas(rec.data, settings.downloadSize || 512, settings);
            const url = canvas.toDataURL('image/png');
            folder.file(`qr_${rec.id+1}.png`,url.split(',')[1],{base64:true});
          }
          const content = await zip.generateAsync({type:'blob'});
          const a = document.createElement('a'); a.href=URL.createObjectURL(content); a.download=`qrcodes_${Date.now()}.zip`;
          document.body.appendChild(a); a.click(); document.body.removeChild(a);
          if (showToast) showToast(t('downloadZip'),'success');
        } catch { if (showToast) showToast('ZIP error','error'); }
        finally { setIsZipping(false); }
      };

      const handleVerify = () => {
        const canvas = qrCanvasRef.current?.querySelector('canvas');
        if (canvas) onVerify(canvas.toDataURL('image/png'));
      };

      const handlePrint = () => {
        const canvas = qrCanvasRef.current?.querySelector('canvas');
        if (!canvas) return;
        const dataUrl = canvas.toDataURL('image/png');
        const safe = settings.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const html = [
          '<!DOCTYPE html><html><head><title>QR Print</title>',
          '<style>body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;',
          'justify-content:center;min-height:100vh;padding:32px;margin:0;}',
          'img{max-width:280px;border:1px solid #ddd;padding:12px;border-radius:12px;}',
          'p{color:#555;font-size:12px;word-break:break-all;max-width:280px;margin:16px 0 0;text-align:center;}',
          'h3{color:#111;font-size:14px;font-weight:600;margin:0 0 4px;}',
          '</style></head><body>',
          `<img src="${dataUrl}"/>`,
          `<h3>QuickQReader</h3><p>${safe}</p>`,
          '<scr'+'ipt>window.onload=function(){window.print();};<'+'/scr'+'ipt>',
          '</body></html>'
        ].join('');
        const w = window.open('','_blank','width=420,height=550');
        if (w) { w.document.write(html); w.document.close(); }
      };

      const loadFavoriteSettings = (favSettings) => {
        setSettings(p=>({...p,...favSettings}));
        if (favSettings.text) { setInputText(favSettings.text); setCsvRecords([]); setActiveTemplate(''); }
      };

      const TEMPLATE_LIST = [
        {id:'url',label:t('templateUrl'),icon:Icons.Link},
        {id:'wifi',label:t('templateWifi'),icon:Icons.Wifi},
        {id:'email',label:t('templateEmail'),icon:Icons.Mail},
        {id:'phone',label:t('templatePhone'),icon:Icons.Phone},
        {id:'text',label:t('templateText'),icon:Icons.Type},
      ];

      const complexity = getComplexity(settings.text, settings.level);
      const cxColor = complexity<35?'bg-green-500':complexity<65?'bg-yellow-500':complexity<85?'bg-orange-500':'bg-red-500';
      const cxText  = complexity<35?'text-green-600 dark:text-green-400':complexity<65?'text-yellow-600 dark:text-yellow-400':complexity<85?'text-orange-600 dark:text-orange-400':'text-red-600 dark:text-red-400';

      return (
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-6xl mx-auto">
          {showFavorites && <FavoritesModal settings={settings} onLoad={loadFavoriteSettings} onClose={()=>setShowFavorites(false)} t={t} showToast={showToast}/>}
          {showBulkPreview && <BulkPreviewModal records={csvRecords} settings={settings} onClose={()=>setShowBulkPreview(false)} t={t}/>}

          <div className="lg:col-span-7 space-y-5">
            {/* Input Card */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 border border-gray-100 dark:border-gray-700">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-lg font-bold">{t('inputText')}</h2>
                <div className="flex gap-2">
                  <label className="text-sm px-3 py-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer rounded-lg transition-colors flex items-center gap-1.5 font-medium">
                    <Icons.FileArchive size={14}/>{t('importCsv')}
                    <input type="file" className="hidden" accept=".csv" onChange={handleCsvUpload}/>
                  </label>
                  <button onClick={handlePaste} className="text-sm px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors font-medium flex items-center gap-1.5">
                    <Icons.Clipboard size={14}/>{t('paste')}
                  </button>
                </div>
              </div>

              {/* Templates */}
              {csvRecords.length===0 && (
                <div className="mb-4">
                  <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">{t('templates')}</div>
                  <div className="flex gap-2 flex-wrap">
                    {TEMPLATE_LIST.map(({id,label,icon:Icon})=>(
                      <button key={id} onClick={()=>handleTemplateChange(id)}
                        className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold transition-all ${activeTemplate===id?'bg-blue-600 text-white shadow-md':'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'}`}>
                        <Icon size={13}/>{label}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {csvRecords.length>0 ? (
                <div className="flex flex-col gap-4">
                  <div className="flex items-center gap-3 bg-gray-50 dark:bg-gray-900 p-4 rounded-xl border border-blue-200 dark:border-blue-800">
                    <button disabled={currentCsvIndex===0} onClick={()=>setCurrentCsvIndex(i=>i-1)} className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full disabled:opacity-30 transition-colors"><Icons.SkipBack size={20}/></button>
                    <div className="flex-1 text-center">
                      <div className="text-xs text-gray-500 uppercase font-bold">{t('csvNav')} {currentCsvIndex+1} / {csvRecords.length}</div>
                      <div className="font-mono truncate mt-1 text-sm">{csvRecords[currentCsvIndex].data}</div>
                    </div>
                    <button disabled={currentCsvIndex===csvRecords.length-1} onClick={()=>setCurrentCsvIndex(i=>i+1)} className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full disabled:opacity-30 transition-colors"><Icons.SkipForward size={20}/></button>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={()=>setShowBulkPreview(true)} className="flex-1 flex items-center justify-center gap-2 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-semibold transition-colors text-sm">
                      <Icons.Grid size={18}/>{t('bulkPreview')}
                    </button>
                    <button onClick={()=>{setCsvRecords([]);setActiveTemplate('url');setInputText('https://');}} className="px-4 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl text-gray-500 text-sm font-medium transition-colors flex items-center gap-1">
                      <Icons.X size={14}/>Clear
                    </button>
                  </div>
                  <button onClick={handleZipDownload} disabled={isZipping}
                    className="w-full flex items-center justify-center gap-2 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold transition-colors shadow-sm disabled:opacity-50">
                    {isZipping?<Icons.RefreshCw className="animate-spin" size={20}/>:<Icons.FileArchive size={20}/>}
                    {isZipping?t('generatingZip'):t('downloadZip')}
                  </button>
                </div>
              ) : activeTemplate==='wifi' ? (
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiSsid')}</label>
                    <input type="text" value={wifiForm.ssid} onChange={e=>setWifiForm(f=>({...f,ssid:e.target.value}))} placeholder="MyNetwork"
                      className="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm"/>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiPassword')}</label>
                    <div className="relative">
                      <input type={showWifiPw?'text':'password'} value={wifiForm.password} onChange={e=>setWifiForm(f=>({...f,password:e.target.value}))} placeholder="••••••••"
                        className="w-full p-3 pr-10 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm"/>
                      <button type="button" onClick={()=>setShowWifiPw(v=>!v)} className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                        {showWifiPw?<Icons.EyeOff size={16}/>:<Icons.Eye size={16}/>}
                      </button>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiEncryption')}</label>
                      <select value={wifiForm.encryption} onChange={e=>setWifiForm(f=>({...f,encryption:e.target.value}))}
                        className="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value="WPA">WPA/WPA2</option><option value="WEP">WEP</option><option value="nopass">{t('wifiEncNone')}</option>
                      </select>
                    </div>
                    <div className="flex items-end pb-1">
                      <label className="flex items-center gap-2 cursor-pointer text-sm">
                        <input type="checkbox" checked={wifiForm.hidden} onChange={e=>setWifiForm(f=>({...f,hidden:e.target.checked}))} className="w-4 h-4 text-blue-600 rounded"/>
                        <span className="text-gray-600 dark:text-gray-300 font-medium">{t('wifiHidden')}</span>
                      </label>
                    </div>
                  </div>
                  {inputText && <div className="p-2 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"><div className="text-xs text-gray-400 font-mono break-all">{inputText}</div></div>}
                </div>
              ) : (
                <div>
                  <textarea value={inputText} onChange={e=>{setInputText(e.target.value);setCsvRecords([]);}}
                    placeholder={activeTemplate==='email'?'mailto:user@example.com':activeTemplate==='phone'?'tel:+1-234-567-8900':'https://...'}
                    className="w-full h-32 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none text-sm"/>
                  <div className="text-right text-xs text-gray-400 mt-1">{inputText.length} {t('charCount')}</div>
                </div>
              )}
            </div>

            {/* Settings Panel */}
            <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700">
              <button onClick={()=>setShowSettings(!showSettings)}
                className="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <span className="font-bold flex items-center gap-2"><Icons.Settings size={18}/>{t('settings')}</span>
                <span className={`transform transition-transform duration-200 ${showSettings?'rotate-180':''}`}>▼</span>
              </button>
              {showSettings && (
                <div className="p-6 space-y-6 animate-fade-in">
                  {/* Colors */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {[['fgColor',t('color')],['bgColor',t('bgColor')],['finderColor',t('finderColor')]].map(([key,label])=>(
                      <div key={key}>
                        <label className="block text-sm font-medium mb-2">{label}</label>
                        <div className="flex items-center gap-2">
                          <input type="color" value={settings[key]} onChange={e=>updateSetting(key,e.target.value)} className="h-10 w-14 rounded-lg cursor-pointer border border-gray-200"/>
                          <span className="text-sm font-mono text-gray-500">{settings[key]}</span>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* Error correction + Shape + Download size */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('errCorrection')}</label>
                      <select value={settings.level} onChange={e=>updateSetting('level',e.target.value)}
                        className="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value="L">L (7%)</option><option value="M">M (15%)</option>
                        <option value="Q">Q (25%)</option><option value="H">H (30%)</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('shape')}</label>
                      <select value={settings.shape} onChange={e=>updateSetting('shape',e.target.value)}
                        className="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value="square">Square</option><option value="dots">Dots</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-2">{t('downloadSize')}</label>
                      <select value={settings.downloadSize} onChange={e=>updateSetting('downloadSize',Number(e.target.value))}
                        className="w-full p-2.5 rounded-xl bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm">
                        <option value={256}>256 px</option><option value={512}>512 px</option>
                        <option value={1024}>1024 px</option><option value={2048}>2048 px</option>
                      </select>
                    </div>
                  </div>

                  {/* Quiet zone + Transparent */}
                  <div className="flex flex-wrap gap-5">
                    <label className="flex items-center gap-2 cursor-pointer text-sm">
                      <input type="checkbox" checked={settings.includeMargin} onChange={e=>updateSetting('includeMargin',e.target.checked)} className="w-4 h-4 text-blue-600 rounded"/>
                      <span className="font-medium">{t('quietZone')}</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer text-sm">
                      <input type="checkbox" checked={settings.transparentBg} onChange={e=>updateSetting('transparentBg',e.target.checked)} className="w-4 h-4 text-blue-600 rounded"/>
                      <span className="font-medium">{t('transparentBg')}</span>
                    </label>
                  </div>

                  {/* Logo Upload */}
                  <div>
                    <label className="block text-sm font-medium mb-2 flex items-center gap-2"><Icons.ImagePlus size={15}/>{t('logoEmbed')}</label>
                    {settings.logoSrc ? (
                      <div className="flex items-center gap-3">
                        <img src={settings.logoSrc} alt="logo" className="w-14 h-14 rounded-xl border border-gray-200 dark:border-gray-700 object-contain bg-white p-1"/>
                        <div>
                          <p className="text-xs text-amber-600 dark:text-amber-400 mb-2">{t('logoNote')}</p>
                          <button onClick={()=>updateSetting('logoSrc',null)} className="text-sm px-3 py-1.5 bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-200 transition-colors flex items-center gap-1">
                            <Icons.X size={13}/>{t('removeLogo')}
                          </button>
                        </div>
                      </div>
                    ) : (
                      <label className="flex items-center gap-2 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl cursor-pointer text-sm font-medium transition-colors w-fit">
                        <Icons.ImagePlus size={16}/>{t('uploadLogo')}
                        <input type="file" className="hidden" accept="image/*" onChange={handleLogoUpload}/>
                      </label>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Preview Panel */}
          <div className="lg:col-span-5">
            <div className="sticky top-6 bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 border border-gray-100 dark:border-gray-700 flex flex-col items-center gap-5">
              <div className="w-full flex justify-between items-center">
                <h2 className="text-xl font-bold">{t('preview')}</h2>
                <div className="flex items-center gap-3">
                  <button onClick={()=>setShowFavorites(true)} className="p-2 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 text-yellow-500 rounded-xl transition-colors" title={t('favorites')}>
                    <Icons.Star size={18}/>
                  </button>
                  <label className="flex items-center gap-1.5 cursor-pointer text-xs font-semibold text-gray-400 uppercase tracking-wide">
                    <input type="checkbox" checked={realtimePreview} onChange={e=>setRealtimePreview(e.target.checked)} className="rounded text-blue-600"/>
                    {t('realtimePreview')}
                  </label>
                </div>
              </div>

              <div ref={qrCanvasRef} className="p-4 bg-white rounded-2xl shadow-inner border border-gray-200 dark:border-gray-600 flex justify-center items-center relative" style={{minHeight:'272px',minWidth:'272px'}}>
                {libError && <div className="absolute inset-0 flex items-center justify-center bg-red-50/90 text-red-500 text-center p-4 rounded-2xl"><p className="font-bold text-sm">{t('libraryError')}</p></div>}
                <QRCodeCanvas key={previewKey} value={displayParams.text||'https://example.com'} size={256}
                  bgColor={displayParams.bgColor} fgColor={displayParams.fgColor}
                  level={displayParams.level} includeMargin={displayParams.includeMargin}
                  shape={displayParams.shape} finderColor={displayParams.finderColor}
                  logoSrc={displayParams.logoSrc} onError={()=>setLibError(true)}/>
              </div>

              {!realtimePreview && (
                <button onClick={triggerManualGenerate} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95">
                  <Icons.RefreshCw size={20}/>{t('generate')}
                </button>
              )}

              {/* Complexity Indicator */}
              <div className="w-full">
                <div className="flex justify-between items-center mb-1.5">
                  <span className="text-xs font-semibold text-gray-500 flex items-center gap-1"><Icons.Gauge size={13}/>{t('complexity')}</span>
                  <span className={`text-xs font-bold ${cxText}`}>{complexity}%</span>
                </div>
                <div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                  <div className={`h-full rounded-full complexity-bar ${cxColor}`} style={{width:`${complexity}%`}}/>
                </div>
                <div className="text-right text-xs text-gray-400 mt-1">{displayParams.level} ECC · {displayParams.text.length} {t('charCount')}</div>
              </div>

              {/* Action buttons */}
              <div className="grid grid-cols-2 gap-2.5 w-full">
                <button onClick={handleVerify} disabled={!settings.text}
                  className="flex items-center justify-center gap-2 px-4 py-2.5 border-2 border-green-500 text-green-600 dark:text-green-400 dark:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-xl font-semibold transition-colors disabled:opacity-40">
                  <Icons.CheckCircle2 size={17}/>{t('verify')}
                </button>
                <button onClick={handlePrint} disabled={!settings.text}
                  className="flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl font-semibold transition-colors disabled:opacity-40">
                  <Icons.Printer size={17}/>{t('printQR')}
                </button>
                <button onClick={downloadQR} disabled={!settings.text}
                  className="flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 hover:opacity-90 rounded-xl font-semibold transition-colors disabled:opacity-40">
                  <Icons.Download size={17}/>PNG
                </button>
                <button onClick={downloadSVG} disabled={!settings.text}
                  className="flex items-center justify-center gap-2 px-4 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl font-semibold transition-colors disabled:opacity-40">
                  <Icons.FileCode size={17}/>SVG
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ─── App ──────────────────────────────────────────────────────────────────
    const App = () => {
      const [activeTab, setActiveTab] = useState(Tab.READ);
      const [lang, setLang] = useState(Language.EN);
      const [theme, setTheme] = useState(Theme.LIGHT);
      const [verificationImage, setVerificationImage] = useState(null);
      const [resetKey, setResetKey] = useState(0);
      const [toasts, setToasts] = useState([]);
      const [confirmDialog, setConfirmDialog] = useState(null);
      const [generatorInitText, setGeneratorInitText] = useState(null);

      const showToast = useCallback((message, type='success') => {
        const id = Date.now()+Math.random();
        setToasts(p=>[...p,{id,message,type}]);
        setTimeout(()=>setToasts(p=>p.filter(t=>t.id!==id)),3000);
      }, []);

      useEffect(() => {
        document.documentElement.classList.toggle('dark', theme===Theme.DARK);
      }, [theme]);

      const handleVerifyRequest = (image) => {
        setVerificationImage(image); setActiveTab(Tab.READ);
        showToast(TRANSLATIONS[lang]['verificationSuccess'],'info');
      };
      const handleSendToGenerator = (text) => {
        setGeneratorInitText(text); setActiveTab(Tab.GENERATE);
        showToast(lang==='jp'?'生成タブへ送りました':'Sent to Generator','info');
      };
      const handleReset = () => {
        setConfirmDialog({
          message: TRANSLATIONS[lang]['confirmResetMsg'],
          confirmLabel: TRANSLATIONS[lang]['confirmResetBtn'],
          cancelLabel: TRANSLATIONS[lang]['cancelBtn'],
          onConfirm: () => { setResetKey(p=>p+1); setVerificationImage(null); setGeneratorInitText(null); setActiveTab(Tab.READ); setConfirmDialog(null); },
          onCancel: () => setConfirmDialog(null),
        });
      };
      const t = (key) => TRANSLATIONS[lang][key];

      return (
        <div className="min-h-screen flex flex-col">
          <ToastContainer toasts={toasts}/>
          {confirmDialog && <ConfirmDialog {...confirmDialog}/>}

          {/* Header */}
          <header className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 sticky top-0 z-50 shadow-sm">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="bg-gradient-to-br from-blue-500 to-indigo-600 p-2 rounded-xl text-white shadow-md">
                  <Icons.QrCode size={22}/>
                </div>
                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400">
                  {t('appTitle')}
                </h1>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={handleReset} className="p-2 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 text-red-400 hover:text-red-500 transition-colors" title={t('reset')}>
                  <Icons.RotateCcw size={19}/>
                </button>
                <div className="h-5 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
                <button onClick={()=>setLang(p=>p===Language.EN?Language.JP:Language.EN)}
                  className="flex items-center gap-1 px-2.5 py-1.5 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors text-sm font-semibold">
                  <Icons.Languages size={17}/>{lang===Language.EN?'EN':'JP'}
                </button>
                <button onClick={()=>setTheme(p=>p===Theme.LIGHT?Theme.DARK:Theme.LIGHT)}
                  className="p-2 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors">
                  {theme===Theme.LIGHT?<Icons.Moon size={19}/>:<Icons.Sun size={19}/>}
                </button>
              </div>
            </div>
          </header>

          {/* Tabs */}
          <div className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex gap-6">
              {[[Tab.READ,Icons.ScanLine,t('tabRead')],[Tab.GENERATE,Icons.QrCode,t('tabGen')]].map(([tab,Icon,label])=>(
                <button key={tab} onClick={()=>setActiveTab(tab)}
                  className={`flex items-center gap-2 py-4 border-b-2 text-sm font-semibold transition-all ${activeTab===tab?'border-blue-600 text-blue-600 dark:text-blue-400':'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'}`}>
                  <Icon size={17}/>{label}
                </button>
              ))}
            </div>
          </div>

          {/* Main */}
          <main className="flex-1 bg-gray-50 dark:bg-gray-950 p-4 sm:p-7 lg:p-10">
            <div className={activeTab===Tab.READ?'block':'hidden'}>
              <QRReader key={`reader-${resetKey}`} lang={lang} initialImage={verificationImage} showToast={showToast} onSendToGenerator={handleSendToGenerator}/>
            </div>
            <div className={activeTab===Tab.GENERATE?'block':'hidden'}>
              <QRGenerator key={`gen-${resetKey}`} lang={lang} onVerify={handleVerifyRequest} showToast={showToast} initialText={generatorInitText}/>
            </div>
          </main>

          {/* Footer */}
          <footer className="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 mt-auto">
            <div className="max-w-7xl mx-auto px-4 py-5 text-center space-y-2">
              <p className="text-xs text-gray-400 dark:text-gray-500">{t('trademark')}</p>
              <div className="h-px bg-gray-100 dark:bg-gray-800 max-w-md mx-auto"></div>
              <p className="text-[11px] text-gray-200 dark:text-gray-700 select-none leading-relaxed max-w-2xl mx-auto">
                MIT License · Copyright © 2025 XNH · Permission is hereby granted, free of charge, to any person obtaining a copy of this software to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies, subject to the condition that this notice is included in all copies. THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND.
              </p>
            </div>
          </footer>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
