<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuickQReader</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              primary: '#3b82f6',
              secondary: '#64748b',
            }
          }
        }
      }
    </script>

    <!-- Dependencies (UMD Globals) -->
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- QR Libraries -->
    <!-- jsQR for reading -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <!-- qrcode for generating (Using cdnjs for better stability) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>

    <!-- Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .animate-slide-up { animation: slideUp 0.25s ease-out; }
      @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      canvas { max-width: 100%; height: auto; }
      .drop-active { outline: 3px dashed #3b82f6 !important; outline-offset: -3px; background-color: rgba(59,130,246,0.05) !important; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/",
    "jsqr": "https://esm.sh/jsqr@^1.4.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "qrcode.react": "https://esm.sh/qrcode.react@^4.2.0",
    "papaparse": "https://esm.sh/papaparse@^5.5.3",
    "jszip": "https://esm.sh/jszip@^3.10.1",
    "qrcode": "https://esm.sh/qrcode@^1.5.4"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;
      const ReactDOM = window.ReactDOM;

      // --- Icons ---
      const Icons = {
        Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
        Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
        Copy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
        Share2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>,
        AlertCircle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
        Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
        Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
        SkipBack: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="19 20 9 12 19 4 19 20"/><line x1="5" x2="5" y1="19" y2="5"/></svg>,
        SkipForward: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>,
        RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
        CheckCircle2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
        FileArchive: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M10 12v-1h4v1"/><path d="M10 18v-1h4v1"/><path d="M10 15v-1h4v1"/></svg>,
        Moon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
        Sun: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>,
        Languages: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>,
        QrCode: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
        ScanLine: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>,
        RotateCcw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
        FileCode: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m9 13 3 3-3 3"/><path d="m15 19-3-3 3-3"/></svg>,
        // New Icons
        Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
        ExternalLink: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h6v6"/><path d="M10 14 21 3"/><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>,
        Mail: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>,
        Phone: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.99 9 19.79 19.79 0 0 1 1.93 .37 2 2 0 0 1 3.91 0h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
        MapPin: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
        Wifi: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>,
        MessageSquare: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
        UserPlus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
        Link: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
        Type: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" x2="15" y1="20" y2="20"/><line x1="12" x2="12" y1="4" y2="20"/></svg>,
        Eye: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
        EyeOff: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
      };

      // --- Constants & Types ---
      const Language = { EN: 'en', JP: 'jp' };
      const Tab = { READ: 'read', GENERATE: 'generate' };
      const Theme = { LIGHT: 'light', DARK: 'dark' };

      const DEFAULT_QR_SETTINGS = {
        text: 'https://example.com',
        fgColor: '#000000',
        bgColor: '#ffffff',
        level: 'M',
        includeMargin: true,
        shape: 'square',
        finderColor: '#000000',
      };

      const TRANSLATIONS = {
        [Language.EN]: {
          appTitle: 'QuickQReader',
          tabRead: 'Read QR',
          tabGen: 'Generate QR',
          scanCamera: 'Scan with Camera',
          uploadImage: 'Upload File',
          urlImage: 'From URL',
          dragDrop: 'Drag & Drop or Click to Upload',
          dragDropActive: 'Drop image here to scan',
          noQrFound: 'No QR code found in image.',
          scannedResult: 'Scanned Result',
          copy: 'Copy',
          share: 'Share',
          copied: 'Copied!',
          inputText: 'Enter URL or Text',
          paste: 'Paste',
          importCsv: 'Import CSV',
          preview: 'Preview',
          settings: 'Settings',
          color: 'Foreground Color',
          bgColor: 'Background Color',
          errCorrection: 'Error Correction Level',
          quietZone: 'Quiet Zone',
          finderColor: 'Finder Pattern Color',
          shape: 'Module Shape',
          generate: 'Generate Image',
          verify: 'Verify',
          download: 'Download PNG',
          downloadSvg: 'Download SVG',
          downloadZip: 'Download ZIP',
          generatingZip: 'Generating ZIP...',
          realtimePreview: 'Real-time Preview',
          csvNav: 'CSV Record',
          startCamera: 'Start Camera',
          stopCamera: 'Stop Camera',
          cameraError: 'Camera access denied or unavailable.',
          verifying: 'Verifying...',
          verificationSuccess: 'Sent to Reader tab for verification!',
          filePreview: 'Image Preview',
          reset: 'Reset',
          pasteError: 'Could not paste. Please allow clipboard access or type manually.',
          libraryError: 'QR Library not loaded. Please check internet connection.',
          trademark: 'QR Code is a registered trademark of DENSO WAVE INCORPORATED.',
          // New keys
          scanHistoryTitle: 'Recent Scans',
          clearHistory: 'Clear',
          noHistory: 'No recent scans.',
          templates: 'Quick Templates',
          charCount: 'chars',
          wifiSsid: 'Network Name (SSID)',
          wifiPassword: 'Password',
          wifiEncryption: 'Encryption',
          wifiHidden: 'Hidden Network',
          sendEmail: 'Send Email',
          callPhone: 'Call',
          sendSms: 'Send SMS',
          openMap: 'Open Map',
          saveContact: 'Save Contact',
          typeUrl: 'URL',
          typeEmail: 'Email',
          typePhone: 'Phone',
          typeSms: 'SMS',
          typeWifi: 'WiFi',
          typeVcard: 'Contact',
          typeGeo: 'Location',
          typeText: 'Text',
          cancelBtn: 'Cancel',
          confirmResetMsg: 'Reset all data? This cannot be undone.',
          confirmResetBtn: 'Reset',
          templateUrl: 'URL',
          templateWifi: 'WiFi',
          templateEmail: 'Email',
          templatePhone: 'Phone',
          templateText: 'Text',
          wifiEncNone: 'None',
        },
        [Language.JP]: {
          appTitle: 'クイックQリーダー',
          tabRead: 'QRコード読み取り',
          tabGen: 'QRコード生成',
          scanCamera: 'カメラでスキャン',
          uploadImage: 'ファイルアップロード',
          urlImage: 'URLから読み込み',
          dragDrop: 'ドラッグ＆ドロップ または クリック',
          dragDropActive: 'ここに画像をドロップ',
          noQrFound: 'QRコードが見つかりませんでした。',
          scannedResult: 'スキャン結果',
          copy: 'コピー',
          share: '共有',
          copied: 'コピー完了！',
          inputText: 'URLまたはテキストを入力',
          paste: '貼り付け',
          importCsv: 'CSV読み込み',
          preview: 'プレビュー',
          settings: '設定',
          color: '前景色',
          bgColor: '背景色',
          errCorrection: '誤り訂正レベル',
          quietZone: 'クワイエットゾーン',
          finderColor: 'ファインダパターン色',
          shape: '形状',
          generate: '画像生成',
          verify: '検証する',
          download: 'ダウンロード (PNG)',
          downloadSvg: 'ダウンロード (SVG)',
          downloadZip: '一括ダウンロード (ZIP)',
          generatingZip: 'ZIP生成中...',
          realtimePreview: 'リアルタイムプレビュー',
          csvNav: 'CSVレコード',
          startCamera: 'カメラ起動',
          stopCamera: 'カメラ停止',
          cameraError: 'カメラへのアクセスが拒否されたか、利用できません。',
          verifying: '検証中...',
          verificationSuccess: '検証用に読み取りタブへ送信しました！',
          filePreview: '画像プレビュー',
          reset: 'リセット',
          pasteError: '貼り付けできませんでした。クリップボードのアクセスを許可するか、手動で入力してください。',
          libraryError: 'QRライブラリが読み込めません。インターネット接続を確認してください。',
          trademark: 'QRコードは株式会社デンソーウェーブの登録商標です。',
          // New keys
          scanHistoryTitle: '最近のスキャン',
          clearHistory: 'クリア',
          noHistory: 'スキャン履歴がありません。',
          templates: 'テンプレート',
          charCount: '文字',
          wifiSsid: 'ネットワーク名 (SSID)',
          wifiPassword: 'パスワード',
          wifiEncryption: '暗号化',
          wifiHidden: '非表示ネットワーク',
          sendEmail: 'メール送信',
          callPhone: '電話する',
          sendSms: 'SMS送信',
          openMap: 'マップを開く',
          saveContact: '連絡先に保存',
          typeUrl: 'URL',
          typeEmail: 'メール',
          typePhone: '電話',
          typeSms: 'SMS',
          typeWifi: 'WiFi',
          typeVcard: '連絡先',
          typeGeo: '位置情報',
          typeText: 'テキスト',
          cancelBtn: 'キャンセル',
          confirmResetMsg: 'すべてのデータをリセットしますか？この操作は元に戻せません。',
          confirmResetBtn: 'リセット',
          templateUrl: 'URL',
          templateWifi: 'WiFi',
          templateEmail: 'メール',
          templatePhone: '電話',
          templateText: 'テキスト',
          wifiEncNone: 'なし',
        }
      };

      // --- QR Type Detection ---
      const detectQRType = (text) => {
        if (!text) return 'text';
        if (/^https?:\/\//i.test(text)) return 'url';
        if (/^mailto:/i.test(text)) return 'email';
        if (/^tel:/i.test(text)) return 'phone';
        if (/^sms:/i.test(text)) return 'sms';
        if (/^WIFI:/i.test(text)) return 'wifi';
        if (/^BEGIN:VCARD/i.test(text)) return 'vcard';
        if (/^geo:/i.test(text)) return 'geo';
        if (/^[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}$/.test(text)) return 'email';
        return 'text';
      };

      const QR_TYPE_META = {
        url:    { color: 'bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300', key: 'typeUrl' },
        email:  { color: 'bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-300', key: 'typeEmail' },
        phone:  { color: 'bg-green-100 dark:bg-green-900/40 text-green-700 dark:text-green-300', key: 'typePhone' },
        sms:    { color: 'bg-teal-100 dark:bg-teal-900/40 text-teal-700 dark:text-teal-300', key: 'typeSms' },
        wifi:   { color: 'bg-cyan-100 dark:bg-cyan-900/40 text-cyan-700 dark:text-cyan-300', key: 'typeWifi' },
        vcard:  { color: 'bg-orange-100 dark:bg-orange-900/40 text-orange-700 dark:text-orange-300', key: 'typeVcard' },
        geo:    { color: 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300', key: 'typeGeo' },
        text:   { color: 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300', key: 'typeText' },
      };

      // --- Toast System ---
      const ToastContainer = ({ toasts }) => (
        <div className="fixed bottom-5 right-5 flex flex-col gap-2 z-[100] pointer-events-none">
          {toasts.map(toast => (
            <div
              key={toast.id}
              className={`flex items-center gap-2 px-4 py-3 rounded-xl shadow-2xl text-sm font-medium animate-slide-up max-w-xs ${
                toast.type === 'success' ? 'bg-green-600 text-white' :
                toast.type === 'error'   ? 'bg-red-600 text-white' :
                toast.type === 'info'    ? 'bg-blue-600 text-white' :
                                           'bg-gray-900 text-white'
              }`}
            >
              {toast.type === 'success' && <Icons.CheckCircle2 size={16} className="shrink-0" />}
              {toast.type === 'error'   && <Icons.AlertCircle size={16} className="shrink-0" />}
              {toast.type === 'info'    && <Icons.ScanLine size={16} className="shrink-0" />}
              <span>{toast.message}</span>
            </div>
          ))}
        </div>
      );

      // --- Confirm Dialog ---
      const ConfirmDialog = ({ message, confirmLabel, cancelLabel, onConfirm, onCancel }) => (
        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[200] animate-fade-in">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 max-w-sm w-full mx-4 animate-slide-up">
            <p className="text-gray-700 dark:text-gray-200 mb-6 leading-relaxed">{message}</p>
            <div className="flex gap-3 justify-end">
              <button
                onClick={onCancel}
                className="px-5 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium"
              >
                {cancelLabel}
              </button>
              <button
                onClick={onConfirm}
                className="px-5 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition-colors font-medium"
              >
                {confirmLabel}
              </button>
            </div>
          </div>
        </div>
      );

      // --- QRCodeCanvas Component ---
      const QRCodeCanvas = ({ value, size, bgColor, fgColor, level, includeMargin, onError }) => {
        const canvasRef = useRef(null);

        useEffect(() => {
          if (!value) return;

          const generate = () => {
             if (window.QRCode && typeof window.QRCode.toCanvas === 'function') {
               if (canvasRef.current) {
                  try {
                    window.QRCode.toCanvas(canvasRef.current, value, {
                      width: size,
                      margin: includeMargin ? 4 : 1,
                      color: {
                        dark: fgColor,
                        light: bgColor
                      },
                      errorCorrectionLevel: level
                    }, (error) => {
                      if (error) {
                        console.error("QR Gen Error:", error);
                        if (onError) onError();
                      }
                    });
                  } catch (err) {
                    console.error("QR Gen Exception:", err);
                    if (onError) onError();
                  }
               }
            } else {
              console.warn("QRCode library not ready yet, retrying...");
              setTimeout(() => {
                 if (window.QRCode && canvasRef.current) {
                     window.QRCode.toCanvas(canvasRef.current, value, {
                      width: size,
                      margin: includeMargin ? 4 : 1,
                      color: {
                        dark: fgColor,
                        light: bgColor
                      },
                      errorCorrectionLevel: level
                    }, (error) => {});
                 } else {
                   if (onError) onError();
                 }
              }, 1000);
            }
          };

          generate();
        }, [value, size, bgColor, fgColor, level, includeMargin, onError]);

        return <canvas ref={canvasRef} />;
      };

      // --- QRReader Component ---
      const QRReader = ({ lang, initialImage, showToast }) => {
        const t = (key) => TRANSLATIONS[lang][key];
        const [activeMode, setActiveMode] = useState('camera');
        const [scanResult, setScanResult] = useState(null);
        const [error, setError] = useState(null);
        const [isCopied, setIsCopied] = useState(false);
        const [previewImage, setPreviewImage] = useState(null);
        const [scanHistory, setScanHistory] = useState([]);
        const [isDragging, setIsDragging] = useState(false);

        const videoRef = useRef(null);
        const canvasRef = useRef(null);
        const dropZoneRef = useRef(null);
        const [isCameraActive, setIsCameraActive] = useState(false);
        const requestRef = useRef(0);

        const addToHistory = useCallback((text) => {
          setScanHistory(prev => {
            const entry = { text, time: Date.now() };
            const filtered = prev.filter(h => h.text !== text);
            return [entry, ...filtered].slice(0, 10);
          });
        }, []);

        const scanImage = useCallback((src) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            if (ctx) {
              ctx.drawImage(img, 0, 0);
              const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
              if (window.jsQR) {
                const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                if (code) {
                  setScanResult(code.data);
                  setError(null);
                  addToHistory(code.data);
                } else {
                  setError(t('noQrFound'));
                  setScanResult(null);
                }
              } else {
                setError("jsQR library not loaded");
              }
            }
          };
          img.onerror = () => setError(t('noQrFound'));
          img.src = src;
        }, [t, addToHistory]);

        useEffect(() => {
          if (initialImage) {
            setActiveMode('file');
            setPreviewImage(initialImage);
            scanImage(initialImage);
          }
        }, [initialImage, scanImage]);

        const stopCamera = useCallback(() => {
          if (videoRef.current && videoRef.current.srcObject) {
            const stream = videoRef.current.srcObject;
            stream.getTracks().forEach(track => track.stop());
            videoRef.current.srcObject = null;
          }
          if (requestRef.current) {
            cancelAnimationFrame(requestRef.current);
          }
          setIsCameraActive(false);
        }, []);

        const tick = useCallback(() => {
          if (videoRef.current && videoRef.current.readyState === videoRef.current.HAVE_ENOUGH_DATA) {
            const canvas = canvasRef.current;
            const video = videoRef.current;
            if (canvas && window.jsQR) {
              canvas.height = video.videoHeight;
              canvas.width = video.videoWidth;
              const ctx = canvas.getContext('2d');
              if (ctx) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = window.jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: "dontInvert",
                });
                if (code) {
                  setScanResult(code.data);
                  setError(null);
                  addToHistory(code.data);
                }
              }
            }
          }
          requestRef.current = requestAnimationFrame(tick);
        }, [addToHistory]);

        const startCamera = async () => {
          setError(null);
          setPreviewImage(null);
          setScanResult(null);

          if (window.location.protocol === 'file:') {
            setError(lang === 'jp'
              ? "セキュリティ上の制限により、ローカルファイル(file://)からカメラを起動することはできません。GitHub Pagesにアップロードするか、ローカルサーバー(localhost)を使用してください。"
              : "Camera access is restricted on local files (file://). Please upload to GitHub Pages or use a local server (http://localhost)."
            );
            return;
          }

          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            setError(t('cameraError'));
            return;
          }

          try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              videoRef.current.setAttribute("playsinline", "true");
              videoRef.current.play();
              setIsCameraActive(true);
              requestRef.current = requestAnimationFrame(tick);
            }
          } catch (err) {
            console.error(err);
            setError(t('cameraError'));
            setIsCameraActive(false);
          }
        };

        useEffect(() => {
          return () => stopCamera();
        }, [stopCamera, activeMode]);

        const loadImageFile = (file) => {
          if (!file || !file.type.startsWith('image/')) return;
          setError(null);
          setScanResult(null);
          setPreviewImage(null);
          const reader = new FileReader();
          reader.onload = (event) => {
            const result = event.target?.result;
            setPreviewImage(result);
            scanImage(result);
          };
          reader.readAsDataURL(file);
        };

        const handleFileUpload = (e) => {
          loadImageFile(e.target.files?.[0]);
        };

        // Drag & Drop handlers
        const handleDragOver = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(true);
        };
        const handleDragLeave = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(false);
        };
        const handleDrop = (e) => {
          e.preventDefault();
          e.stopPropagation();
          setIsDragging(false);
          const file = e.dataTransfer.files?.[0];
          if (file) {
            setActiveMode('file');
            loadImageFile(file);
          }
        };

        const copyToClipboard = () => {
          if (scanResult) {
            navigator.clipboard.writeText(scanResult);
            setIsCopied(true);
            setTimeout(() => setIsCopied(false), 2000);
            if (showToast) showToast(t('copied'), 'success');
          }
        };

        const shareResult = async () => {
          if (scanResult && navigator.share) {
            try {
              await navigator.share({ title: 'Scanned QR Code', text: scanResult });
            } catch (err) {
              console.log('Share canceled');
            }
          }
        };

        const qrType = scanResult ? detectQRType(scanResult) : 'text';
        const typeMeta = QR_TYPE_META[qrType] || QR_TYPE_META.text;

        const getActionButton = () => {
          if (!scanResult) return null;
          switch (qrType) {
            case 'url':
              return (
                <a href={scanResult} target="_blank" rel="noopener noreferrer"
                  className="flex items-center gap-1.5 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.ExternalLink size={15} /> Open Link
                </a>
              );
            case 'email': {
              const href = /^mailto:/i.test(scanResult) ? scanResult : `mailto:${scanResult}`;
              return (
                <a href={href}
                  className="flex items-center gap-1.5 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.Mail size={15} /> {t('sendEmail')}
                </a>
              );
            }
            case 'phone': {
              const href = /^tel:/i.test(scanResult) ? scanResult : `tel:${scanResult}`;
              return (
                <a href={href}
                  className="flex items-center gap-1.5 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.Phone size={15} /> {t('callPhone')}
                </a>
              );
            }
            case 'sms': {
              return (
                <a href={scanResult}
                  className="flex items-center gap-1.5 px-4 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.MessageSquare size={15} /> {t('sendSms')}
                </a>
              );
            }
            case 'geo': {
              const coords = scanResult.replace(/^geo:/i, '').split(',').slice(0, 2).join(',');
              return (
                <a href={`https://maps.google.com/?q=${coords}`} target="_blank" rel="noopener noreferrer"
                  className="flex items-center gap-1.5 px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.MapPin size={15} /> {t('openMap')}
                </a>
              );
            }
            case 'vcard':
              return (
                <button
                  onClick={() => {
                    const blob = new Blob([scanResult], { type: 'text/vcard' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'contact.vcf';
                    a.click();
                    URL.revokeObjectURL(url);
                  }}
                  className="flex items-center gap-1.5 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                  <Icons.UserPlus size={15} /> {t('saveContact')}
                </button>
              );
            case 'wifi': {
              const ssidMatch = scanResult.match(/S:([^;]*)/);
              const ssid = ssidMatch ? ssidMatch[1] : '';
              return (
                <span className="flex items-center gap-1.5 px-3 py-2 bg-cyan-100 dark:bg-cyan-900/30 text-cyan-700 dark:text-cyan-300 rounded-lg text-sm font-medium">
                  <Icons.Wifi size={15} /> {ssid || 'WiFi QR'}
                </span>
              );
            }
            default:
              return null;
          }
        };

        return (
          <div
            className={`flex flex-col gap-5 max-w-3xl mx-auto p-4 rounded-xl transition-colors ${isDragging ? 'drop-active' : ''}`}
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
          >
            {/* Drag overlay hint */}
            {isDragging && (
              <div className="fixed inset-0 z-50 pointer-events-none flex items-center justify-center">
                <div className="bg-blue-600/90 text-white px-8 py-6 rounded-2xl shadow-2xl text-xl font-bold flex flex-col items-center gap-3">
                  <Icons.Upload size={40} />
                  {t('dragDropActive')}
                </div>
              </div>
            )}

            {/* Mode Switcher */}
            <div className="flex gap-2 justify-center bg-gray-200 dark:bg-gray-800 p-1 rounded-lg self-center">
              <button
                onClick={() => setActiveMode('camera')}
                className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeMode === 'camera' ? 'bg-white dark:bg-gray-700 shadow-sm' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}
              >
                <Icons.Camera size={18} /> {t('scanCamera')}
              </button>
              <button
                onClick={() => setActiveMode('file')}
                className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeMode === 'file' ? 'bg-white dark:bg-gray-700 shadow-sm' : 'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}
              >
                <Icons.Upload size={18} /> {t('uploadImage')}
              </button>
            </div>

            {/* Input Area */}
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 min-h-[280px] flex flex-col items-center justify-center border border-gray-100 dark:border-gray-700">
              {activeMode === 'camera' && (
                <div className="w-full flex flex-col items-center gap-4">
                  <div className="relative w-full max-w-md aspect-square bg-black rounded-lg overflow-hidden">
                     <video ref={videoRef} className="w-full h-full object-cover" />
                     <canvas ref={canvasRef} className="hidden" />
                     {!isCameraActive && (
                       <div className="absolute inset-0 flex items-center justify-center text-white/40">
                          <Icons.Camera size={64} />
                       </div>
                     )}
                     {isCameraActive && (
                       <div className="absolute inset-0 pointer-events-none">
                         <div className="absolute inset-[20%] border-2 border-white/60 rounded-lg"></div>
                         <div className="absolute top-[20%] left-[20%] w-5 h-5 border-t-2 border-l-2 border-blue-400 rounded-tl"></div>
                         <div className="absolute top-[20%] right-[20%] w-5 h-5 border-t-2 border-r-2 border-blue-400 rounded-tr"></div>
                         <div className="absolute bottom-[20%] left-[20%] w-5 h-5 border-b-2 border-l-2 border-blue-400 rounded-bl"></div>
                         <div className="absolute bottom-[20%] right-[20%] w-5 h-5 border-b-2 border-r-2 border-blue-400 rounded-br"></div>
                       </div>
                     )}
                  </div>
                  <button
                    onClick={isCameraActive ? stopCamera : startCamera}
                    className={`px-8 py-2.5 rounded-full font-medium text-white transition-colors shadow ${isCameraActive ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                  >
                    {isCameraActive ? t('stopCamera') : t('startCamera')}
                  </button>
                </div>
              )}

              {activeMode === 'file' && (
                <div className="w-full max-w-md flex flex-col items-center gap-4">
                  <label className="flex flex-col items-center justify-center w-full h-36 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-xl cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                    <div className="flex flex-col items-center justify-center gap-2">
                      <Icons.Upload className="w-8 h-8 text-gray-400" />
                      <p className="text-sm text-gray-500 dark:text-gray-400 font-medium">{t('dragDrop')}</p>
                    </div>
                    <input type="file" className="hidden" accept="image/*" onChange={handleFileUpload} />
                  </label>

                  {previewImage && (
                    <div className="w-full border border-gray-200 dark:border-gray-700 rounded-lg p-2 bg-gray-50 dark:bg-gray-900">
                      <div className="text-xs text-gray-500 mb-2 font-medium">{t('filePreview')}</div>
                      <img src={previewImage} alt="Preview" className="max-h-64 mx-auto rounded shadow-sm" />
                    </div>
                  )}
                </div>
              )}

              {error && (
                <div className="mt-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-lg flex items-center gap-2 animate-fade-in w-full max-w-md">
                  <Icons.AlertCircle size={18} className="shrink-0" />
                  <span>{error}</span>
                </div>
              )}
            </div>

            {/* Scan Result */}
            {scanResult && (
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-green-100 dark:border-green-900/30 animate-slide-up">
                <div className="flex items-center gap-2 mb-3 flex-wrap">
                  <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-200">{t('scannedResult')}</h3>
                  <span className={`text-xs px-2.5 py-0.5 rounded-full font-semibold ${typeMeta.color}`}>
                    {t(typeMeta.key)}
                  </span>
                </div>
                <div className="bg-gray-100 dark:bg-gray-950 p-4 rounded-lg font-mono break-all text-sm mb-4 border border-gray-200 dark:border-gray-700">
                  {scanResult}
                </div>
                <div className="flex gap-2 flex-wrap items-center">
                  <button
                    onClick={copyToClipboard}
                    className="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                  >
                    <Icons.Copy size={15} /> {isCopied ? t('copied') : t('copy')}
                  </button>
                  {navigator.share && (
                    <button
                      onClick={shareResult}
                      className="flex items-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm font-medium transition-colors"
                    >
                      <Icons.Share2 size={15} /> {t('share')}
                    </button>
                  )}
                  <div className="ml-auto">
                    {getActionButton()}
                  </div>
                </div>
              </div>
            )}

            {/* Scan History */}
            {scanHistory.length > 0 && (
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4 border border-gray-100 dark:border-gray-700 animate-fade-in">
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-semibold text-sm text-gray-600 dark:text-gray-300 flex items-center gap-1.5">
                    <Icons.Clock size={15} /> {t('scanHistoryTitle')}
                  </h3>
                  <button
                    onClick={() => setScanHistory([])}
                    className="text-xs text-gray-400 hover:text-red-500 dark:hover:text-red-400 transition-colors flex items-center gap-1"
                  >
                    <Icons.X size={12} /> {t('clearHistory')}
                  </button>
                </div>
                <div className="space-y-1.5">
                  {scanHistory.map((entry) => {
                    const etype = detectQRType(entry.text);
                    const emeta = QR_TYPE_META[etype] || QR_TYPE_META.text;
                    return (
                      <button
                        key={entry.time}
                        onClick={() => setScanResult(entry.text)}
                        className="w-full text-left p-2.5 rounded-lg bg-gray-50 dark:bg-gray-700/60 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-sm flex items-center gap-2 group"
                      >
                        <Icons.Clock size={13} className="text-gray-400 shrink-0" />
                        <span className="flex-1 font-mono truncate text-gray-600 dark:text-gray-300 text-xs">{entry.text}</span>
                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-semibold shrink-0 ${emeta.color}`}>
                          {TRANSLATIONS[lang][emeta.key]}
                        </span>
                      </button>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        );
      };

      // --- QRGenerator Component ---
      const QRGenerator = ({ lang, onVerify, showToast }) => {
        const t = (key) => TRANSLATIONS[lang][key];

        const [settings, setSettings] = useState(DEFAULT_QR_SETTINGS);
        const [inputText, setInputText] = useState('');
        const [csvRecords, setCsvRecords] = useState([]);
        const [currentCsvIndex, setCurrentCsvIndex] = useState(0);
        const [realtimePreview, setRealtimePreview] = useState(true);
        const [showSettings, setShowSettings] = useState(false);
        const [previewKey, setPreviewKey] = useState(0);
        const [isZipping, setIsZipping] = useState(false);
        const [libError, setLibError] = useState(false);
        const [activeTemplate, setActiveTemplate] = useState('url');
        const [wifiForm, setWifiForm] = useState({ ssid: '', password: '', encryption: 'WPA', hidden: false });
        const [showWifiPw, setShowWifiPw] = useState(false);

        const qrCanvasRef = useRef(null);

        // Sync WiFi form → inputText
        useEffect(() => {
          if (activeTemplate === 'wifi' && wifiForm.ssid) {
            const wifiString = `WIFI:T:${wifiForm.encryption};S:${wifiForm.ssid};P:${wifiForm.password};H:${wifiForm.hidden ? 'true' : 'false'};;`;
            setInputText(wifiString);
            setCsvRecords([]);
          }
        }, [wifiForm, activeTemplate]);

        useEffect(() => {
          if (csvRecords.length > 0) {
            setSettings(prev => ({ ...prev, text: csvRecords[currentCsvIndex].data }));
          } else if (inputText) {
            setSettings(prev => ({ ...prev, text: inputText }));
          }
        }, [csvRecords, currentCsvIndex, inputText]);

        const handleTemplateChange = (tpl) => {
          setActiveTemplate(tpl);
          setCsvRecords([]);
          if (tpl === 'url') setInputText('https://');
          else if (tpl === 'email') setInputText('mailto:');
          else if (tpl === 'phone') setInputText('tel:+');
          else if (tpl === 'sms') setInputText('sms:+');
          else if (tpl === 'text') setInputText('');
          else if (tpl === 'wifi') {
            setWifiForm({ ssid: '', password: '', encryption: 'WPA', hidden: false });
            setInputText('');
          }
        };

        const handleCsvUpload = (e) => {
          const file = e.target.files?.[0];
          if (file && window.Papa) {
            window.Papa.parse(file, {
              complete: (results) => {
                const records = results.data
                  .flat()
                  .filter((cell) => typeof cell === 'string' && cell.trim() !== '')
                  .map((text, index) => ({ id: index, data: text }));

                if (records.length > 0) {
                  setCsvRecords(records);
                  setCurrentCsvIndex(0);
                  setActiveTemplate('');
                }
              }
            });
          }
        };

        const handlePaste = async () => {
          try {
            const text = await navigator.clipboard.readText();
            setInputText(text);
            setCsvRecords([]);
            setActiveTemplate('');
          } catch (err) {
            console.error('Paste failed', err);
            if (showToast) showToast(t('pasteError'), 'error');
          }
        };

        const downloadQR = () => {
          const canvas = qrCanvasRef.current?.querySelector('canvas');
          if (canvas) {
            try {
              const url = canvas.toDataURL('image/png');
              const a = document.createElement('a');
              a.href = url;
              a.download = `qrcode-${Date.now()}.png`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              if (showToast) showToast(t('download'), 'success');
            } catch (e) {
              console.error("Download failed", e);
              if (showToast) showToast('Failed to download image.', 'error');
            }
          } else {
            if (showToast) showToast('QR Code not rendered yet.', 'error');
          }
        };

        const downloadSVG = () => {
          if (!settings.text) return;

          if (!window.QRCode || typeof window.QRCode.toString !== 'function') {
            if (showToast) showToast(t('libraryError'), 'error');
            return;
          }

          const opts = {
            errorCorrectionLevel: settings.level,
            margin: settings.includeMargin ? 4 : 1,
            color: {
              dark: settings.fgColor,
              light: settings.bgColor
            },
            width: 512,
            type: 'svg'
          };

          try {
            window.QRCode.toString(settings.text, opts, (err, svgString) => {
              if (err) {
                console.error(err);
                if (showToast) showToast('SVG Generation Error', 'error');
                return;
              }

              const blob = new Blob([svgString], { type: 'image/svg+xml' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `qrcode-${Date.now()}.svg`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
              if (showToast) showToast(t('downloadSvg'), 'success');
            });
          } catch (e) {
            console.error(e);
            if (showToast) showToast('Failed to generate SVG.', 'error');
          }
        };

        const handleZipDownload = async () => {
          if (csvRecords.length === 0 || !window.JSZip || !window.QRCode) return;
          setIsZipping(true);

          try {
            const zip = new window.JSZip();
            const folder = zip.folder("qrcodes");

            if (folder) {
              for (const record of csvRecords) {
                const url = await window.QRCode.toDataURL(record.data, {
                  errorCorrectionLevel: settings.level,
                  margin: settings.includeMargin ? 4 : 1,
                  color: {
                    dark: settings.fgColor,
                    light: settings.bgColor
                  },
                  width: 512,
                });

                const base64Data = url.split(',')[1];
                folder.file(`qr_${record.id + 1}.png`, base64Data, {base64: true});
              }

              const content = await zip.generateAsync({type:"blob"});
              const a = document.createElement("a");
              a.href = URL.createObjectURL(content);
              a.download = `qrcodes_batch_${Date.now()}.zip`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(a.href);
              if (showToast) showToast(t('downloadZip'), 'success');
            }
          } catch (error) {
            console.error("ZIP Generation Error", error);
            if (showToast) showToast('Error generating ZIP file.', 'error');
          } finally {
            setIsZipping(false);
          }
        };

        const handleVerify = () => {
          const canvas = qrCanvasRef.current?.querySelector('canvas');
          if (canvas) {
              const dataUrl = canvas.toDataURL('image/png');
              onVerify(dataUrl);
          }
        };

        const updateSetting = (key, value) => {
          setSettings(prev => ({ ...prev, [key]: value }));
        };

        const [displayParams, setDisplayParams] = useState(DEFAULT_QR_SETTINGS);

        useEffect(() => {
          if (realtimePreview) {
            setDisplayParams(settings);
          }
        }, [settings, realtimePreview]);

        const triggerManualGenerate = () => {
          setDisplayParams(settings);
          setPreviewKey(prev => prev + 1);
        };

        const TEMPLATE_LIST = [
          { id: 'url', label: t('templateUrl'), icon: Icons.Link },
          { id: 'wifi', label: t('templateWifi'), icon: Icons.Wifi },
          { id: 'email', label: t('templateEmail'), icon: Icons.Mail },
          { id: 'phone', label: t('templatePhone'), icon: Icons.Phone },
          { id: 'text', label: t('templateText'), icon: Icons.Type },
        ];

        return (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-6xl mx-auto p-4">
            <div className="lg:col-span-7 space-y-5">
              {/* Text Input Card */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 border border-gray-100 dark:border-gray-700">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-bold">{t('inputText')}</h2>
                  <div className="flex gap-2">
                    <label className="text-sm px-3 py-1.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 cursor-pointer rounded-lg transition-colors flex items-center gap-1.5 font-medium">
                      <Icons.FileArchive size={14} /> {t('importCsv')}
                      <input type="file" className="hidden" accept=".csv" onChange={handleCsvUpload} />
                    </label>
                    <button onClick={handlePaste} className="text-sm px-3 py-1.5 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors font-medium flex items-center gap-1.5">
                      <Icons.Copy size={14} /> {t('paste')}
                    </button>
                  </div>
                </div>

                {/* Quick Templates */}
                {csvRecords.length === 0 && (
                  <div className="mb-4">
                    <div className="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">{t('templates')}</div>
                    <div className="flex gap-2 flex-wrap">
                      {TEMPLATE_LIST.map(({ id, label, icon: Icon }) => (
                        <button
                          key={id}
                          onClick={() => handleTemplateChange(id)}
                          className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold transition-colors ${
                            activeTemplate === id
                              ? 'bg-blue-600 text-white shadow-sm'
                              : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600'
                          }`}
                        >
                          <Icon size={13} /> {label}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {csvRecords.length > 0 ? (
                  <div className="flex flex-col gap-4">
                    <div className="flex items-center gap-4 bg-gray-50 dark:bg-gray-900 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                      <button
                        disabled={currentCsvIndex === 0}
                        onClick={() => setCurrentCsvIndex(i => i - 1)}
                        className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full disabled:opacity-30"
                      >
                        <Icons.SkipBack size={20} />
                      </button>
                      <div className="flex-1 text-center">
                        <div className="text-xs text-gray-500 uppercase font-bold">{t('csvNav')} {currentCsvIndex + 1} / {csvRecords.length}</div>
                        <div className="font-mono truncate mt-1">{csvRecords[currentCsvIndex].data}</div>
                      </div>
                      <button
                        disabled={currentCsvIndex === csvRecords.length - 1}
                        onClick={() => setCurrentCsvIndex(i => i + 1)}
                        className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full disabled:opacity-30"
                      >
                        <Icons.SkipForward size={20} />
                      </button>
                    </div>
                    <button
                      onClick={() => { setCsvRecords([]); setActiveTemplate('url'); setInputText('https://'); }}
                      className="text-sm text-gray-500 hover:text-red-500 transition-colors self-end flex items-center gap-1"
                    >
                      <Icons.X size={13} /> Clear CSV
                    </button>
                    <button
                      onClick={handleZipDownload}
                      disabled={isZipping}
                      className="w-full flex items-center justify-center gap-2 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold transition-colors shadow-sm disabled:opacity-50"
                    >
                      {isZipping ? (
                        <Icons.RefreshCw className="animate-spin" size={20} />
                      ) : (
                        <Icons.FileArchive size={20} />
                      )}
                      {isZipping ? t('generatingZip') : t('downloadZip')}
                    </button>
                  </div>
                ) : activeTemplate === 'wifi' ? (
                  /* WiFi Form */
                  <div className="space-y-3">
                    <div>
                      <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiSsid')}</label>
                      <input
                        type="text"
                        value={wifiForm.ssid}
                        onChange={e => setWifiForm(f => ({ ...f, ssid: e.target.value }))}
                        placeholder="MyNetwork"
                        className="w-full p-3 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiPassword')}</label>
                      <div className="relative">
                        <input
                          type={showWifiPw ? 'text' : 'password'}
                          value={wifiForm.password}
                          onChange={e => setWifiForm(f => ({ ...f, password: e.target.value }))}
                          placeholder="••••••••"
                          className="w-full p-3 pr-10 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                        />
                        <button
                          type="button"
                          onClick={() => setShowWifiPw(v => !v)}
                          className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
                        >
                          {showWifiPw ? <Icons.EyeOff size={16} /> : <Icons.Eye size={16} />}
                        </button>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{t('wifiEncryption')}</label>
                        <select
                          value={wifiForm.encryption}
                          onChange={e => setWifiForm(f => ({ ...f, encryption: e.target.value }))}
                          className="w-full p-2.5 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-sm"
                        >
                          <option value="WPA">WPA/WPA2</option>
                          <option value="WEP">WEP</option>
                          <option value="nopass">{t('wifiEncNone')}</option>
                        </select>
                      </div>
                      <div className="flex items-end pb-2">
                        <label className="flex items-center gap-2 cursor-pointer text-sm">
                          <input
                            type="checkbox"
                            checked={wifiForm.hidden}
                            onChange={e => setWifiForm(f => ({ ...f, hidden: e.target.checked }))}
                            className="w-4 h-4 text-blue-600 rounded"
                          />
                          <span className="text-gray-600 dark:text-gray-300 font-medium">{t('wifiHidden')}</span>
                        </label>
                      </div>
                    </div>
                    {inputText && (
                      <div className="p-2 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700">
                        <div className="text-xs text-gray-400 font-mono break-all">{inputText}</div>
                      </div>
                    )}
                  </div>
                ) : (
                  <div>
                    <textarea
                      value={inputText}
                      onChange={(e) => {
                        setInputText(e.target.value);
                        setCsvRecords([]);
                      }}
                      placeholder={activeTemplate === 'email' ? 'mailto:user@example.com' : activeTemplate === 'phone' ? 'tel:+1-234-567-8900' : 'https://...'}
                      className="w-full h-32 p-4 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-none text-sm"
                    />
                    <div className="text-right text-xs text-gray-400 mt-1">{inputText.length} {t('charCount')}</div>
                  </div>
                )}
              </div>

              {/* Settings Panel */}
              <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden border border-gray-100 dark:border-gray-700">
                <button
                  onClick={() => setShowSettings(!showSettings)}
                  className="w-full flex justify-between items-center p-4 bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                >
                  <span className="font-bold flex items-center gap-2">
                    <Icons.Settings size={18} /> {t('settings')}
                  </span>
                  <span className={`transform transition-transform ${showSettings ? 'rotate-180' : ''}`}>▼</span>
                </button>

                {showSettings && (
                  <div className="p-6 space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">{t('color')}</label>
                        <div className="flex items-center gap-2">
                          <input
                            type="color"
                            value={settings.fgColor}
                            onChange={(e) => updateSetting('fgColor', e.target.value)}
                            className="h-10 w-14 rounded cursor-pointer"
                          />
                          <span className="text-sm font-mono text-gray-500">{settings.fgColor}</span>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">{t('bgColor')}</label>
                        <div className="flex items-center gap-2">
                          <input
                            type="color"
                            value={settings.bgColor}
                            onChange={(e) => updateSetting('bgColor', e.target.value)}
                            className="h-10 w-14 rounded cursor-pointer"
                          />
                          <span className="text-sm font-mono text-gray-500">{settings.bgColor}</span>
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">{t('finderColor')} (Simulated)</label>
                         <div className="flex items-center gap-2">
                          <input
                            type="color"
                            value={settings.finderColor}
                            onChange={(e) => updateSetting('finderColor', e.target.value)}
                            className="h-10 w-14 rounded cursor-pointer"
                          />
                          <span className="text-sm font-mono text-gray-500">{settings.finderColor}</span>
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">{t('errCorrection')}</label>
                        <select
                          value={settings.level}
                          onChange={(e) => updateSetting('level', e.target.value)}
                          className="w-full p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600"
                        >
                          <option value="L">Level L (7%)</option>
                          <option value="M">Level M (15%)</option>
                          <option value="Q">Level Q (25%)</option>
                          <option value="H">Level H (30%)</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">{t('shape')}</label>
                         <select
                          value={settings.shape}
                          onChange={(e) => updateSetting('shape', e.target.value)}
                          className="w-full p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600"
                        >
                          <option value="square">Square (Default)</option>
                          <option value="dots">Dots (Simulated)</option>
                        </select>
                      </div>
                    </div>

                     <div className="flex items-center gap-2">
                       <input
                        type="checkbox"
                        id="includeMargin"
                        checked={settings.includeMargin}
                        onChange={(e) => updateSetting('includeMargin', e.target.checked)}
                        className="w-4 h-4 text-blue-600 rounded"
                       />
                       <label htmlFor="includeMargin" className="text-sm font-medium">{t('quietZone')}</label>
                     </div>
                  </div>
                )}
              </div>
            </div>

            {/* Preview Panel */}
            <div className="lg:col-span-5">
              <div className="sticky top-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 border border-gray-100 dark:border-gray-700 flex flex-col items-center">
                <div className="w-full flex justify-between items-center mb-5">
                  <h2 className="text-xl font-bold">{t('preview')}</h2>
                  <div className="flex items-center gap-2">
                    <label className="flex items-center gap-2 cursor-pointer text-xs uppercase font-semibold text-gray-500">
                      <input
                        type="checkbox"
                        checked={realtimePreview}
                        onChange={(e) => setRealtimePreview(e.target.checked)}
                        className="rounded text-blue-600 focus:ring-blue-500"
                      />
                      {t('realtimePreview')}
                    </label>
                  </div>
                </div>

                <div
                  ref={qrCanvasRef}
                  className="p-4 bg-white rounded-lg shadow-inner border border-gray-200 flex justify-center items-center relative"
                  style={{ minHeight: '280px', minWidth: '280px' }}
                >
                   {libError && (
                     <div className="absolute inset-0 flex items-center justify-center bg-red-50/90 text-red-500 text-center p-4">
                       <p className="font-bold text-sm">{t('libraryError')}</p>
                     </div>
                   )}
                   <QRCodeCanvas
                      key={previewKey}
                      value={displayParams.text || 'https://example.com'}
                      size={256}
                      bgColor={displayParams.bgColor}
                      fgColor={displayParams.fgColor}
                      level={displayParams.level}
                      includeMargin={displayParams.includeMargin}
                      onError={() => setLibError(true)}
                    />
                </div>

                {!realtimePreview && (
                   <button
                      onClick={triggerManualGenerate}
                      className="mt-4 w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold flex items-center justify-center gap-2 transition-transform active:scale-95"
                    >
                     <Icons.RefreshCw size={20} /> {t('generate')}
                   </button>
                )}

                <div className="grid grid-cols-2 gap-3 w-full mt-5">
                  <button
                    onClick={handleVerify}
                    disabled={!settings.text}
                    className="flex items-center justify-center gap-2 px-4 py-2 border-2 border-green-500 text-green-600 dark:text-green-400 dark:border-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Icons.CheckCircle2 size={18} /> {t('verify')}
                  </button>
                  <button
                    onClick={downloadQR}
                    disabled={!settings.text}
                    className="flex items-center justify-center gap-2 px-4 py-2 bg-gray-900 dark:bg-gray-100 text-white dark:text-gray-900 hover:opacity-90 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Icons.Download size={18} /> PNG
                  </button>
                  <button
                    onClick={downloadSVG}
                    disabled={!settings.text}
                    className="col-span-2 flex items-center justify-center gap-2 px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Icons.FileCode size={18} /> {t('downloadSvg')}
                  </button>
                </div>

                <div className="mt-4 text-xs text-gray-400 text-center max-w-xs">
                  {displayParams.level} ECC • {displayParams.text.length} {t('charCount')}
                </div>
              </div>
            </div>

          </div>
        );
      };

      // --- Main App Component ---
      const App = () => {
        const [activeTab, setActiveTab] = useState(Tab.READ);
        const [lang, setLang] = useState(Language.EN);
        const [theme, setTheme] = useState(Theme.LIGHT);
        const [verificationImage, setVerificationImage] = useState(null);
        const [resetKey, setResetKey] = useState(0);
        const [toasts, setToasts] = useState([]);
        const [confirmDialog, setConfirmDialog] = useState(null);

        const showToast = useCallback((message, type = 'success') => {
          const id = Date.now() + Math.random();
          setToasts(prev => [...prev, { id, message, type }]);
          setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
        }, []);

        useEffect(() => {
          if (theme === Theme.DARK) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }, [theme]);

        const toggleTheme = () => {
          setTheme(prev => prev === Theme.LIGHT ? Theme.DARK : Theme.LIGHT);
        };

        const toggleLang = () => {
          setLang(prev => prev === Language.EN ? Language.JP : Language.EN);
        };

        const handleVerifyRequest = (image) => {
          setVerificationImage(image);
          setActiveTab(Tab.READ);
          showToast(TRANSLATIONS[lang]['verificationSuccess'], 'info');
        };

        const handleReset = () => {
          setConfirmDialog({
            message: TRANSLATIONS[lang]['confirmResetMsg'],
            confirmLabel: TRANSLATIONS[lang]['confirmResetBtn'],
            cancelLabel: TRANSLATIONS[lang]['cancelBtn'],
            onConfirm: () => {
              setResetKey(prev => prev + 1);
              setVerificationImage(null);
              setActiveTab(Tab.READ);
              setConfirmDialog(null);
            },
            onCancel: () => setConfirmDialog(null),
          });
        };

        const t = (key) => TRANSLATIONS[lang][key];

        return (
          <div className="min-h-screen flex flex-col font-sans transition-colors duration-200">
            {/* Toast Notifications */}
            <ToastContainer toasts={toasts} />

            {/* Confirm Dialog */}
            {confirmDialog && (
              <ConfirmDialog
                message={confirmDialog.message}
                confirmLabel={confirmDialog.confirmLabel}
                cancelLabel={confirmDialog.cancelLabel}
                onConfirm={confirmDialog.onConfirm}
                onCancel={confirmDialog.onCancel}
              />
            )}

            {/* Header */}
            <header className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 sticky top-0 z-50">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="bg-blue-600 p-2 rounded-lg text-white">
                    <Icons.QrCode size={24} />
                  </div>
                  <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600 dark:from-blue-400 dark:to-indigo-400">
                    {t('appTitle')}
                  </h1>
                </div>

                <div className="flex items-center gap-3">
                   <button
                    onClick={handleReset}
                    className="p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 transition-colors"
                    aria-label="Reset"
                    title={t('reset')}
                  >
                    <Icons.RotateCcw size={20} />
                  </button>
                  <div className="h-6 w-px bg-gray-200 dark:bg-gray-700 mx-1"></div>
                   <button
                    onClick={toggleLang}
                    className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors"
                    aria-label="Toggle Language"
                  >
                    <div className="flex items-center gap-1 text-sm font-medium">
                      <Icons.Languages size={18} />
                      <span>{lang === Language.EN ? 'EN' : 'JP'}</span>
                    </div>
                  </button>
                  <button
                    onClick={toggleTheme}
                    className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-300 transition-colors"
                    aria-label="Toggle Theme"
                  >
                    {theme === Theme.LIGHT ? <Icons.Moon size={20} /> : <Icons.Sun size={20} />}
                  </button>
                </div>
              </div>
            </header>

            {/* Navigation Tabs */}
            <div className="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex gap-8">
                <button
                  onClick={() => setActiveTab(Tab.READ)}
                  className={`flex items-center gap-2 py-4 border-b-2 text-sm font-medium transition-colors ${
                    activeTab === Tab.READ
                      ? 'border-blue-600 text-blue-600 dark:text-blue-400'
                      : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
                  }`}
                >
                  <Icons.ScanLine size={18} />
                  {t('tabRead')}
                </button>
                <button
                  onClick={() => setActiveTab(Tab.GENERATE)}
                  className={`flex items-center gap-2 py-4 border-b-2 text-sm font-medium transition-colors ${
                    activeTab === Tab.GENERATE
                      ? 'border-blue-600 text-blue-600 dark:text-blue-400'
                      : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'
                  }`}
                >
                  <Icons.QrCode size={18} />
                  {t('tabGen')}
                </button>
              </div>
            </div>

            {/* Main Content */}
            <main className="flex-1 bg-gray-50 dark:bg-gray-950 p-4 sm:p-6 lg:p-8 overflow-y-auto">
              <div className={activeTab === Tab.READ ? 'block' : 'hidden'}>
                <QRReader key={`reader-${resetKey}`} lang={lang} initialImage={verificationImage} showToast={showToast} />
              </div>

              <div className={activeTab === Tab.GENERATE ? 'block' : 'hidden'}>
                <QRGenerator key={`gen-${resetKey}`} lang={lang} onVerify={handleVerifyRequest} showToast={showToast} />
              </div>
            </main>

            <footer className="bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 p-4 text-center mt-auto">
              <p className="text-xs text-gray-500 dark:text-gray-400">
                {t('trademark')}
              </p>
            </footer>

          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
